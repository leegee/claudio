<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <title>Map Uploader</title>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <link rel="apple-touch-icon" href="icon.png">

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>

        <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

        <script>
        var Config = {
            apikey: 'AIzaSyDAdOILIN2SPM_1iPKJMbHd9jOck8H9J7o',
            clientId: '837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/fusiontables',
            fusion: {
                name: 'lee-dev',
                countiesTableId: '1CP_uYV52MKV42Qt7O3TrpzS1sr7JBWPMIWxw4sQV',
                sheetNameStem: 'lee-dev-',
                maxRetries: 3
            },
            endpoints: {
                uploadSkus: '/cgi-bin/upload-skus.cgi'
            }
        };

        var authorise = function () {
            gapi.auth.authorize({
                client_id: Config.clientId,
                scope: Config.scopes,
                immediate: true
            }, handleAuthResult);
        };

        var handleAuthResult = function (authResult) {
            console.log('authResult = ', authResult);
            if (authResult && !authResult.error) {
                console.log('Authorised!');
                window.wizard = new Wizard( authResult.access_token );
                window.wizard.nextPage();
            } else {
                console.log('Not authorised');
                var el = document.getElementById('authButton');
                // No access token could be retrieved, show the button to start the authorization flow.
                el.addEventListener('click', authorise);
                el.setAttribute('style', 'display:block');
            }
        };

        const  authString = function () {
            return 'key=' + Config.apikey + '&access_token=' + window.wizard.access_token;
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(),
            );
            return (await response.json()).items;
        }

        var page1 = async function () {
            window.wizard.fusionTableDetails = await asyncListTables();
            window.wizard.nextPage();
            // .then( (items) => {
            //     window.wizard.fusionTableDetails = items;
            //     window.wizard.nextPage();
            // });
        }

        var page2 = function () {
            document.getElementById('skusCsv').addEventListener('change', function () {
                window.wizard.skusToProcess = document.getElementById('skusToProcess').value;
                window.wizard.file = this.files[0];
                window.wizard.nextPage();
            }, false);
            document.getElementById('selectFusionTable').addEventListener('click', function () {
                var selectList = document.getElementById('fusionTableIds');
                window.wizard.tableId = selectList.options[ selectList.selectedIndex ].value;
                window.wizard.gotoPageName('merge');
            });
        }

        var page3 = function () {
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => {window.wizard.nextPage()}, false);
        }            

        var page4 = function () {
            console.log('Enter page4');
            var show = (msg) => {document.getElementById('logWindow').innerHTML = msg};
            var data = new FormData();
            data.append('skus-text', window.wizard.skusToProcess);
            data.append('skus-file', window.wizard.file);
            var request = new XMLHttpRequest();
            request.onreadystatechange = () => {
                if (request.readyState === 3 && request.responseText) {
                    show(request.responseText);
                } else if (request.readyState === XMLHttpRequest.DONE) {
                    show('<pre>' + request.responseText + '</pre>');
                    try {
                        console.log('res=',  JSON.parse(request.responseText) );
                        window.wizard.indexRes = JSON.parse(request.responseText);
                        // window.wizard.nextPage();
                    } catch (e) {
                        console.log('res=',  request.responseText );
                    }
                    stophere;
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadSkus + '?' + authString());
            request.send(data);
        }


        var publishFusionTable = async function (path, name, retries) {
            retries = retries || 0;
            console.log('Will call ');
            var form = new FormData();
            form.append('file', path);

/*
            return await window.fetch('https://www.googleapis.com/fusiontables/v2/tables'
                + '?uploadType=media'
                + '&name=' + name
                + '&' + authString(),
                {
                    method: 'POST',
                    headers: new Headers({'content-type': 'application/octet-stream'}),
                    body: form
                }
            ).then( (response) => {
                var res = response.json();
                console.log(res);
                if (res.error && retries < Config.fusion.maxRetries) {
                    publishFusionTable( path, name, ++retries ); // , tries );
                    console.error('Retry ', retries);
                } else {
                    // populateFusionTable({ 
                    //     res: res,
                    //     name: name,
                    //     path: path
                    // });
                }
            })
*/
        };


        var page5 = function () {
            console.log('page 5: ', window.wizard.indexRes);
            var promisesAllDone = [];
            window.wizard.indexRes.fusiontables.forEach( (path, i) => {
                console.log('Publish table', i, path);
                promisesAllDone.push(
                    publishFusionTable(path, Config.fusion.sheetNameStem + i)
                );
            });
            Promise.all( promisesAllDone ).then( () => {
                window.wizard.nextPage();
            });
        }

        var page6 = function () {
            // console.log('page 6 - request a merge of ', window.wizard.tableId);
            // var data = new FormData;
            // data.append('tableId', window.wizard.tableId);
            // data.append('countiesTableId', Config.fusion.countiesTableId);
            // var request = new XMLHttpRequest();
            // request.onreadystatechange = () => {
            //     console.log('request.readyState', request.readyState, XMLHttpRequest.DONE);
            //     if (request.readyState === XMLHttpRequest.DONE) {
            //         console.log( request.responseText );
            //     }
            // }
            // request.open(
            //     'POST', 
            //     'https://www.googleapis.com/upload/fusiontables/v2/tables/import'
            //     // 'https://www.googleapis.com/fusiontables/v2/tables/import' 
            //     // 'https://www.googleapis.com/upload/upload/fusiontables/v2/tables/import'
            //     + '?uploadType=media'
            //     + '&name=Testing'  
            //     + '&' + authString()
            // );
            // request.setRequestHeader('content-type', 'application/octet-stream');
            // request.send(data);
        }

        var Wizard = function (access_token) {
            this.access_token = access_token;
            this.page = 0;
            this.el = {
                main: document.getElementById('main'),
                pageNumber: document.getElementById('pageNumber')
            };
            this.el.main.setAttribute('style', 'display:block"');
            this.el.pageNumber.setAttribute('style', 'display:block"');
        }

        /**
         * Show a numbered page that also has data-name attribute that equates to the passed pageName argument
         * 
         * @param {string} pageName - string matching an element's `data-name` attribute.
         * @returns void
         */
        Wizard.prototype.gotoPageName = function (pageName) {
            console.log('Wizard ', this, ' page ', this.page, ' to named page ', pageName);
            this.nextPage(
                document.querySelector('script[type="text/mustache"][data-name="merge"]').id.match(/^page-(\d+)$/)[1]
            );
        }

        /**
         * Hides the current page, and processes and shows the template for the element
         * for the page element whose * `id` attribute matches 
         * the prefix `page-` suffixed with the incremented page number. If a function
         * exists matching the suffix `page` with the prefix of the page number, it 
         * will be called after the template has been processed and displayed.
         * 
         * @param {number} [pageNumber] - Optional page number to which to jump.
         * @return void
         */
        Wizard.prototype.nextPage = function (pageNumber) {
            pageNumber = pageNumber || this.page + 1;
            console.log('Wizard ', this, 'from page', this.page, 'to page number ', pageNumber);
            this.page = pageNumber;

            try {
                this.el.main.innerHTML = Mustache.render(
                    document.getElementById('page-' + this.page).innerHTML.toString(), 
                    {Config: Config, wizard: wizard}
                );
                this.el.pageNumber.innerText = this.page;
            } catch (e) {
                console.error(e);
            }
            
            var fn = 'page' + this.page;
            if (typeof window[fn] === 'function') {
                window[fn]( arguments );
            }
            console.log('Page = ', this.page);
        }
       </script>

        <script type='text/mustache' id='page-1'>
            <p>
                <button id='authButton' name='authButton'>Log In</button>
            </p>
        </script>

        <script type='text/mustache' id='page-2'>
            <fieldset>
                <div id='enterSkusToProcess'>
                    <p><label for='skusToProess'>Please enter a list of USDA symbols/SKUs to proceess. Separate mulitple values with spaces and/or commas.</p>
                    <p><textarea id='skusToProcess' name='skusToProcess'></textarea>
                </div>
            </fieldset>
            <fieldset>
                <div id='selectCsv'>
                    <p><label for='skusCsv'>To create a new Fusion Table, select a SKU CSV file from your local machine:</label></p>
                    <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
                </div>
                <div id='listFusionTables'>
                    <p>Or choose an existing Fusion Table from this list of tables stored in your Google account:</p>
                    <select id='fusionTableIds' name='fusionTableIds'>
                        {{#wizard.fusionTableDetails}}
                            <option value='{{tableId}}'>{{name}} - {{description}}</option>
                        {{/wizard.fusionTableDetails}}
                    </select>
                    <button id='selectFusionTable' name='selectFusionTable'>Choose</button>
                </fieldset>
            </div>
        </script>

        <script type='text/mustache' id='page-3'>
            Page 3. 
            <div id='meta'>
                <p>USDA SKUs to process:</p>
                <p>{{window.wizard.skusToProcess}}</p>
            <dl>
                <dt>Name<dt><dd>{{wizard.file.name}}</dd>
                <dt>Size<dt><dd>{{wizard.file.size}}</dd>
                <dt>Last Modified<dt><dd>{{wizard.file.lastModifiedDate}}</dd>
            </dl>
            <button id="upload-skus">Add this file's skus to the map</button>
            <button id="cancel-skus">Cancel</button>
        </script>

        <script type='text/mustache' id='page-4'>
            <div id='logWindow'>
                <p>Formatting data to upload to Google .... please wait.</p>
            </div>
        </script>

        <script type='text/mustache' id='page-5'>
            <p>{{window.wizard}}</p>
            <p>See https://www.googleapis.com/drive/v2 /files /files/$fileid </p>
            <p>Merge with https://drive.google.com/open?id=1CP_uYV52MKV42Qt7O3TrpzS1sr7JBWPMIWxw4sQV</p>
        </script>

        <script type='text/mustache' id='page-6' data-name='merge'>
            Merging the two files....
        </script>

    </head>
    <body>
        <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

        <header>
            <h1>Map Updater <span id='pageNumber'>1</span></h1>
        </header>

        <main id='main'>
            <p>
                We have too much data to fit into a single Fusion table, so this
                app creates several tables and an index which is referenced by
                the map pages.
            </p>
            <p>
                Authorising with Google....
            </p>
            <p>
                <button style='display:none' id='authButton' name='authButton'>Log In</button>
            </p>
        </main>


        <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script> 
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

        <script src="https://apis.google.com/js/client.js?onload=authorise"></script>
    </body>
</html>
