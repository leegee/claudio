<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Map Uploader</title>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">
        
        <link rel="manifest" href="site.webmanifest">
        <link rel="apple-touch-icon" href="icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>

        <script>
        var Config = {
            apikey: 'AIzaSyDAdOILIN2SPM_1iPKJMbHd9jOck8H9J7o',
            clientId: '837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/fusiontables',
            fusion: {
                name: 'lee-dev',
            },
            endpoints: {
                uploadSkus: '/cgi-bin/upload-skus.cgi'
            }
        };


        function handleClientLoad() {
            window.setTimeout(checkAuth, 1);
        }

        function checkAuth() {
            gapi.auth.authorize({
                client_id: Config.clientId,
                scope: Config.scopes,
                immediate: true
            }, handleAuthResult);
        }

        function handleAuthResult(authResult) {
            console.log('authResult', authResult);
            if (authResult && !authResult.error) {
            // Access token has been successfully retrieved, requests can be sent to the API.
                window.wizard = new Wizard( authResult.access_token );
                window.wizard.nextPage();
            } else {
                // No access token could be retrieved, show the button to start the authorization flow.
                authButton.style.display = 'block';
                authButton.addEventListener('click', checkAuth);
            }
        }

        var page1 = function () {
            window.wizard.nextPage();
        }

        var page2 = function () {
            document.getElementById('skus').addEventListener('change', function() {
                window.wizard.file = this.files[0];
                window.wizard.nextPage();
            }, false);
        }

        var page3 = function () {
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => {window.wizard.nextPage()}, false);
        }            

        var page4 = function () {
            var data = new FormData();
            data.append('skus-csv', window.wizard.file);
            var request = new XMLHttpRequest();
            request.onreadystatechange = () => {
                console.log('request.readyState', request.readyState, XMLHttpRequest.DONE);
                console.log('res=', request.responseText);
                if (request.readyState === XMLHttpRequest.DONE) {
                    window.wizard.lastResponseText = request.responseText;
                    if (request.responseText.indexOf('Software error') === -1) {
                        console.log('-------------ok------------');
                        console.log(request.responseText);
                        window.wizard.geoSkuData = request.responseText;
                        // var json = JSON.parse(request.responseText);
                        // console.log(json);
                        // window.wizard.geoSkuPath = json.path;
                        // window.wizard.geoSkuData = json.data;
                        window.wizard.nextPage();
                    }
                }
            }
            request.open('POST', Config.endpoints.uploadSkus);
            request.send(data);
        }

        // https://developers.google.com/fusiontables/docs/v2/upload
        var page5 = function () {
            console.log('page 5');
            // var data = new FormData();
            // data.append('uploadType', 'media');
            // data.append('name', Config.fusion.name);
            // data.append('filename')
            var data = window.wizard.geoSkuData;
            console.log('data length', data.length);
            var request = new XMLHttpRequest();
            request.onreadystatechange = () => {
                console.log('request.readyState', request.readyState, XMLHttpRequest.DONE);
                console.log('res=', request.responseText);
                if (request.readyState === XMLHttpRequest.DONE) {
                    window.Wizard.lastResponseText = request.responseText;
                }
            }
            request.open(
                'POST', 
                'https://www.googleapis.com/upload/fusiontables/v2/tables/import'
                // 'https://www.googleapis.com/fusiontables/v2/tables/import' 
                // 'https://www.googleapis.com/upload/upload/fusiontables/v2/tables/import'
                + '?uploadType=media'
                + '&key=' + Config.apikey
                + '&access_token=' + window.wizard.access_token
            );
            request.send(data);
        }

        var Wizard = function (access_token) {
            this.access_token = access_token;
            this.page = 0;
            this.el = {
                main: document.getElementById('main'),
                pageNumber: document.getElementById('pageNumber')
            };
            this.el.pageNumber.setAttribute('style', 'display:block"');
        }
        Wizard.prototype.nextPage = function () {
            console.log('Wizard ', this, 'Page ', this.page, 'to', this.page + 1);
            this.page ++;
            try {
                this.el.main.innerHTML = Mustache.render(
                    document.getElementById('page-' + this.page).innerHTML.toString(), 
                    {Config: Config, wizard: wizard}
                );
                this.el.pageNumber.innerText = this.page;
            } catch (e) {
                console.error(e);
            }
            var fn = 'page' + this.page;
            if (typeof window[fn] === 'function') {
                window[fn]( arguments );
            }
            console.log('Page = ', this.page);
        }
       </script>

        <script type='text/mustache' id='page-1'>
            <button id='sign-in'>Sign In</button>
        </script>

        <script type='text/mustache' id='page-2'>
            <div id='select'>
                <p><label for='skus'>Select the SKU CSV file:</label></p>
                <p><input type='file' name='skus' id='skus' placeholder='SKUs CSV' type='.csv'></p>
            </div>
        </script>

        <script type='text/mustache' id='page-3'>
            Page 3. 
            <div id='meta'>
            <dl>
                <dt>Name<dt><dd>{{wizard.file.name}}</dd>
                <dt>Size<dt><dd>{{wizard.file.size}}</dd>
                <dt>Last Modified<dt><dd>{{wizard.file.lastModifiedDate}}</dd>
            </dl>
            <button id="upload-skus">Add this file's skus to the map</button>
            <button id="cancel-skus">Cancel</button>
        </script>

        <script type='text/mustache' id='page-4'>
            Talking to the server....
        </script>

        <script type='text/mustache' id='page-5'>
            <p>{{window.wizard.geoSkuData}}</p>
            <p>See https://www.googleapis.com/drive/v2 /files /files/$fileid </p>
            <p>Merge with https://drive.google.com/open?id=1CP_uYV52MKV42Qt7O3TrpzS1sr7JBWPMIWxw4sQV</p>
        </script>

        <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
    </head>
    <body>
        <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

        <header>
            <h1>Map Updater <span id='pageNumber'>1</span></h1>
        </header>
        <main id='main'>
            Authorising with Google....
        </main>


        <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script> 
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->
    </body>
</html>
