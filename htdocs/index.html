<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Map Uploader</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>

    <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

    <script>
        var Config, Config_Url = 'Config.js';

        var ENTER = async function () {
            var _ = await fetch(Config_Url);
            Config = await _.json();
            gapi.auth.authorize({
                client_id: Config.clientId,
                scope: Config.scopes,
                immediate: true
            }, handleAuthResult);
        };

        var handleAuthResult = function (authResult) {
            console.log('authResult = ', authResult);
            if (authResult && !authResult.error) {
                window.wizard = new Wizard({
                    indexBaseDir: Config.indexBaseDir,
                    indexJsDir: Config.indexBaseDir + new Date().toISOString().replace(/\W/g, '_'),
                    access_token: authResult.access_token
                });
                window.wizard.nextPage('intro');
            } else {
                console.log('Not authorised');
                var el = document.getElementById('authButton');
                // No access token could be retrieved, show the button to start the authorization flow.
                el.addEventListener('click', ENTER);
                el.setAttribute('style', 'display:block');
                window.wizard.nextPage('manual-auth');
            }
        };

        const authString = function () {
            return 'key=' + Config.apikey + '&access_token=' + window.wizard.state.access_token;
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(),
            );
            return (await response.json()).items;
        }

        var pageSelectSkusAfterRender = async function () {
            console.log('Enter page2-------------------------------');
            // window.wizard.fusionTableDetails = await asyncListTables();
            //     window.wizard.nextPage();
            // }

            document.getElementById('skusCsv').addEventListener('change', (e) => {
                this.state.skusToProcess = document.getElementById('skusToProcess').value;
                this.state.file = e.target.files[0];
                this.nextPage('preview-upload');
            }, false);
            // document.getElementById('selectFusionTable').addEventListener('click', function () {
            //     var selectList = document.getElementById('fusionTableIds');
            //     window.wizard.state.tableId = selectList.options[ selectList.selectedIndex ].value;
            //     window.wizard.nextPage('merge');
            // });
        }

        var pagePreviewUploadAfterRender = function () {
            console.log('Enter uploadAfterRender');
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => { window.wizard.nextPage('upload-skus') }, false);
        }

        /**
        * Before the cx closes, server will respond with HTML status updates.
        */
        var pageUploadSkusAfterRender = async function () {
            console.log('Enter upload to send to CGI');
            var buffer = '',
                data = new FormData(),
                logwindow = document.getElementById('logWindow'),
                request = new XMLHttpRequest(),
                show = (html) => {
                    logwindow.innerHTML = html;
                    logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                }
                ;

            data.append('skus-text', window.wizard.state.skusToProcess);
            data.append('skus-file', window.wizard.state.file);
            data.append('index_js_dir', window.wizard.state.indexJsDir);

            request.onreadystatechange = () => {
                if (request.responseText.length) {
                    show(request.responseText);
                }
                if (request.readyState === XMLHttpRequest.DONE) {
                    console.log('CGI processing and Google processing complete.');
                    window.wizard.nextPage('review-specific-index');
                    return Promise.resolve();
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadSkus + '?' + authString());
            request.send(data);
        }

        var pageReviewSpecificIndexBeforeRender = async function ([e]) {
            var jobName = e.target.innerText;
            var url = this.state.indexBaseDir + '/' + jobName + '/index.js';
            var response = await window.fetch(url);
            var json = await response.json();
            this.state.skus2ids = [];
            for (var sku in json.skus2tableIds) {
                this.state.skus2ids.push( { sku, id: json.skus2tableIds[sku]});
            }
            console.log('Leave pageReviewSpecificIndexBeforeRender with ', this.state.skus2ids)
        }

        // Relies upon server auto-indexing (NB .htaccess created in Izel.pm)
        var pageReviewIndexesBeforeRender = async function () {
            var response = await window.fetch(
                this.state.indexBaseDir
            );
            var text = await response.text();
            wizard.state.indexes = _linksFromText(text);
        }

        var _linksFromText = function (str) {
            var match;
            var rv = [];
            do {
                match = /\bhref=(.)([^/]+?)\/\1/g.exec(str);
                if (match) rv.push(match[2]);
            } while (match);
            return rv;
        }

        /**
         * Pages are `script` elements of `type` `text/mustache`,
         *  with a `data-page-name` attribute.
         *
         * @example
         *  <script type=<script type='text/mustache' data-page-name='manual-auth'> ...
         *
         * Pages are displayed via `Wizard.nextPage(:pageName)`.
         *
         * ## Data for Page Templates
         *
         * The Wizard supplies itself as `wizard`.
         *
         * ## Linking Within Pages
         *
         * Before templates are displayed, hyperlinks are added to any element that has an attribute
         * `data-goto-page`: the attribute's value can be a page name.
         *
         * ## Code For Pages
         *
         * Before a page is rendered, the Wizard will try to call a function with a camel-cased version
         * of the ant-cased page name, prefixed with the word 'page'.
         *
         * @example
         *  <script type=<script type='text/mustache' data-page-name='manual-auth'> ...
         *  function pageManualAuth () { ...
         *
         * After a page is displayed, the Wizard will try to call a function with the same name, and the
         * suffix 'AfterRender`:
         *
         *  function pageManualAuthAfterRender () { ...
         *
         * Note that a suffix `BeforeRender` may be added to the function called before the page is rendered.
         *
         *  function pageManualAuthBeforeRender () { ...
         *
         * All three functions are called in the context of the Wizard.
         *
         * Yeah, @decorators would be nice without trainspoiling.
         *
         */
        var Wizard = function (state) {
            this.state = {
                pageName: ''
            }; // window.history.popstate();?
            Object.keys(state).forEach((key) => {
                this.state[key] = state[key];
            });
            this.pageEl = null;
            this.el = {
                main: document.getElementById('main'),
            };
            this.el.main.setAttribute('style', 'display:block"');
            window.popstate = (e) => {
                console.log('POPSTATE ', e);
                return false;  //pushstate
            };
        }

        /**
         * Hides the current page, and processes and shows the template for the element
         * for the page element whose * `id` attribute matches
         * the prefix `page-` suffixed with the incremented page number. If a function
         * exists matching the suffix `page` with the prefix of the page number, it
         * will be called after the template has been processed and displayed.
         *
         * If the numbered page does not exist, the page with the next-highest number is shown.
         *
         * Also, if no arg supplied, tries to find data-next-page='name|number' from the current page.
         *
         * @param {number} [pageNumber] - Optional page number to which to jump.
         * @return void
         */
        Wizard.prototype.nextPage = async function (pageName, ...passOnArgs) {
            console.log('Enter Wizard.nextPage with %s -----------------------------------------', pageName);

            // If not told where to go, check the current template for instructions
            if (! pageName && this.pageEl.nextPageName) {
                pageName = this.pageEl.nextPageName;
                console.log('Got next-page pageName from data-next-page: ', pageName);
            }

            this.pageEl = document.querySelector('script[type="text/mustache"][data-page-name="' + pageName + '"]');
            if (! this.pageEl) {
                this.el.main.innerHTML = '<h2>Error</h2><p>Could not find the requested page, ' + pageName + '</p>';
                return;
            }
            this.state.nextPageName = this.pageEl.dataset.nextPage || null;

            this.state.pageName = pageName;

            var fnNames = [
                'page-' + this.state.pageName,
                'page-' + this.state.pageName + '-before-render'
            ];

            await this._execute(fnNames, passOnArgs);

            this.render();

            if (this.state.pageName) {
                await this._execute('page-' + this.state.pageName + '-after-render', passOnArgs);
            }

            window.location.hash = this.state.pageName;
            window.history.pushState( this.state, 'Page '+this.state.pageName, window.location.toString() );

            console.log('Leave nextPage with page = ', this.state.pageName);
        }

        Wizard.prototype._execute = async function (fns, passOnArgs) {
            console.log('Wizard._execute', fns);
            if (! fns) return;
            var promises = [];
            if (typeof fns === 'string') fns = [fns];
            for (f of fns) {
                var fn = this._antsToCamelCase(f);
                console.log('Look for ', fn);
                if (typeof window[fn] === 'function') {
                    console.log('Found %s, calling....', fn);
                    promises.push( window[fn].call(this, passOnArgs) );
                    console.log('...called  %s', fn);
                } else {
                    console.log('Did not find ', fn);
                }
            }
            if (promises) {
                await Promise.all(promises);
            }
            else {
                return Promise.resolve();
            }
        };

        Wizard.prototype.render = function () {
            console.log('Enter render');
            try {
                this.el.main.innerHTML = Mustache.render(
                    this.pageEl.innerHTML.toString(),
                    { wizard: this }
                );
                var links = document.querySelectorAll('[data-goto-page]');
                for (var el of links) {
                    el.onclick = (e) => {
                        window.wizard.nextPage(e.target.dataset.gotoPage, e);
                    };
                };
            } catch (e) {
                console.error(e);
            }
        }

        Wizard.prototype._antsToCamelCase = function (str) {
            return str.replace(/-(\w)/g, (_, initial) => {
                return initial.toUpperCase();
            });
        }

    </script>

    <script type='text/mustache' id='page-100' data-page-name='manual-auth'>
        <p>
            <button id='authButton' name='authButton'>Log In</button>
        </p>
    </script>

    <script type='text/mustache' data-page-name='intro'>
        <p>
            We have too much data to fit into a single Fusion table, so this
            app creates several tables and an index which is referenced by
            the map pages.
        </p>
        <ul>
            <li data-goto-page='select-skus'>Uupload SKU geography</lia>
            <li data-goto-page='review-indexes'>Publish previously uploaded SKU geography</li>
        </ul>
    </script>

    <script type='text/mustache'data-page-name='select-skus'>
        <h2>Upload SKU Geography</h2>
        <div id='enterSkusToProcess'>
            <p><label for='skusToProess'>Please enter a list of USDA symbols/SKUs to proceess. Separate mulitple values with spaces and/or commas.</p>
            <ul><textarea id='skusToProcess' name='skusToProcess'></textarea>
        </div>
        <div id='selectCsv'>
            <p><label for='skusCsv'>To create a new Fusion Table, select a SKU CSV file from your local machine:</label></p>
            <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
        </div>
        <!--
        <div id='listFusionTables' style='display:none'>
            <p>Or choose an existing Fusion Table from this list of tables stored in your Google account:</p>
            <select id='fusionTableIds' name='fusionTableIds'>
                {{#wizard.fusionTableDetails}}
                    <option value='{{tableId}}'>{{name}} - {{description}}</option>
                {{/wizard.fusionTableDetails}}
            </select>
            <button id='selectFusionTable' name='selectFusionTable'>Choose</button>
        -->
    </script>

    <script type='text/mustache' id='page-3' data-page-name='preview-upload'>
        <h2>Does this look right?</h2>
        <p>USDA SKUs to process:</p>
        <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button id="upload-skus">Process this SKU/geography file?</button>
        <button id="cancel-skus">Cancel</button>
    </script>

    <script type='text/mustache' id='page-4' data-page-name='upload-skus'>
        <h2>Creating maps... </h2>
        <div id='logWindow'></div>
    </script>

    <script type='text/mustache' id='page-10' data-page-name='review-indexes'>
        <h2>Please select an index</h2>
        {{window.wizard.state.indexes}}
        <ul>
            {{#wizard.state.indexes}}
                <li data-goto-page='review-specific-index'>{{.}}</li>
            {{/wizard.state.indexes}}
        </ul>
    </script>

    <script type='text/mustache' id='page-11' data-page-name='no-indexes'>
        <h2>There are no indexes.</h2>
        <p>Please upload some SKU/geography.</h2>
    </script>

    <script type='text/mustache' id='page-20' data-page-name='review-specific-index'>
        <h2>Preview Maps</h2>
        <ul>
        {{#wizard.state.skus2ids}}
            <li>
                <a target='_new' href='preview-map.html?sku={{sku}};tableId={{id}}'>
                    {{sku}}
                </a>
            </li>
        {{/wizard.state.skus2ids}}
        </ul>
    </script>

</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <header>
        <h1>Map Updater</h1>
    </header>

    <main id='main'>
        <h2>Welcome to the map making page.</h2>
        <p>
            Authorising with Google....
        </p>
        <p>
            <button style='display:none' id='authButton' name='authButton'>Log In</button>
        </p>
    </main>


    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

    <script src="https://apis.google.com/js/client.js?onload=ENTER"></script>
</body>

</html>