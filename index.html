<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Map Uploader</title>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">
        
        <link rel="manifest" href="site.webmanifest">
        <link rel="apple-touch-icon" href="icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>

        <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>

        <script>
        var App = {
            fusion: {
                name: 'lee-dev',
            },
            endpoints: {
                uploadSkus: '/cgi-bin/upload-skus.cgi'
            }
        };

        function handleClientLoad() {
            // Loads the client library and the auth2 library together for efficiency.
            // Loading the auth2 library is optional here since `gapi.client.init` function will load
            // it if not already loaded. Loading it upfront can save one network request.
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            // Initialize the client with API key and People API, and initialize OAuth with an
            // OAuth 2.0 client ID and scopes (space delimited string) to request access.
            gapi.client.init({
                apiKey: 'AIzaSyDAdOILIN2SPM_1iPKJMbHd9jOck8H9J7o',
                // discoveryDocs: ["https://people.googleapis.com/$discovery/rest?version=v1"],
                clientId: '837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com',
                scope: 'profile https://www.googleapis.com/auth/fusiontables'
            }).then(function () {
                // Listen for sign-in state changes:
                // gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    window.wizard.nextPage();
                }
            });
        }

        function makeApiCall() {
            // Make an API call to the People API, and print the user's given name.
            gapi.client.people.people.get({
                'resourceName': 'people/me',
                'requestMask.includeField': 'person.names'
            }).then(function(response) {
                console.log('Hello, ' + response.result.names[0].givenName);
            }, function(reason) {
                console.log('Error: ' + reason.result.error.message);
            });
        }

        // Show the first page (login) when the DOM is ready
        document.addEventListener("DOMContentLoaded", function(event) {
            // document.getElementsByClassName('page 1')[0].setAttribute('style', 'display: block');
            window.wizard = new Wizard();
            window.wizard.nextPage();
        });

        var page1 = function () {
            document.getElementById('sign-in').addEventListener('click', () => {
                gapi.auth2.getAuthInstance().signIn().then( () => {
                    window.wizard.nextPage();
                })
            });
        }

        var page2 = function () {
            document.getElementById('skus').addEventListener('change', function() {
                App.file = this.files[0];
                window.wizard.nextPage();
            }, false);
        }

        var page3 = function () {
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => {window.wizard.nextPage()}, false);
        }            

        var page4 = function () {
            var data = new FormData();
            data.append('skus-csv', App.file);
            var request = new XMLHttpRequest();
            request.onreadystatechange = () => {
                console.log('request.readyState', request.readyState, XMLHttpRequest.DONE);
                console.log('res=', request.responseText);
                if (request.readyState === XMLHttpRequest.DONE) {
                    App.lastResponseText = request.responseText;
                    if (request.responseText.indexOf('Software error') === -1) {
                        console.log('-------------ok------------');
                        console.log(request.responseText);
                        var json = JSON.parse(request.responseText);
                        console.log(json);
                        App.geoSkuPath = json.path;
                        window.wizard.nextPage();
                    }
                }
            }
            request.open('POST', App.endpoints.uploadSkus);
            request.send(data);
        }

        var page5 = function () {
            console.log('page 5, path = ', App.geoSkuPath);
            var data = new FormData();
            data.append('uploadType', 'media');
            data.append('name', App.fusion.name);
            var request = new XMLHttpRequest();
            request.onreadystatechange = () => {
                console.log('request.readyState', request.readyState, XMLHttpRequest.DONE);
                console.log('res=', request.responseText);
                if (request.readyState === XMLHttpRequest.DONE) {
                    App.lastResponseText = request.responseText;
                }
            }
            request.open('POST', 'https://www.googleapis.com/upload/fusiontables/v2/tables/import');
            request.send(data);
        }

        var Wizard = function () {
            this.page = 0;
            this.el = {
                currentPage: document.getElementById('currentPage')
            }
        }
        Wizard.prototype.nextPage = function () {
            console.log('Wizard ', this, 'Page ', this.page, 'to', this.page + 1);
            this.page ++;
            try {
                document.getElementById('main').innerHTML = Mustache.render(
                    document.getElementById('page-' + this.page).innerHTML.toString(), 
                    {App: App}
                );
                this.el.currentPage.innerText = this.page;
            } catch (e) {
                console.error(e);
            }
            var fn = 'page' + this.page;
            if (typeof window[fn] === 'function') {
                window[fn]( arguments );
            }
            console.log('Page = ', this.page);
        }
       </script>

        <script type='text/mustache' id='page-1'>
            <button id='sign-in'>Sign In</button>
        </script>

        <script type='text/mustache' id='page-2'>
            <div id='select'>
                <p><label for='skus'>Select the SKU CSV file:</label></p>
                <p><input type='file' name='skus' id='skus' placeholder='SKUs CSV' type='.csv'></p>
            </div>
        </script>

        <script type='text/mustache' id='page-3'>
            Page 3. 
            <div id='meta'>
            <dl>
                <dt>Name<dt><dd>{{App.file.name}}</dd>
                <dt>Size<dt><dd>{{App.file.size}}</dd>
                <dt>Last Modified<dt><dd>{{App.file.lastModifiedDate}}</dd>
            </dl>
            <button id="upload-skus">Add this file's skus to the map</button>
            <button id="cancel-skus">Cancel</button>
        </script>

        <script type='text/mustache' id='page-4'>
            Talking to the server....
        </script>

        <script type='text/mustache' id='page-5'>
            <p>{{App.geoSkuPath}}</p>
            <p>See https://www.googleapis.com/drive/v2 /files /files/$fileid </p>
            <p>Merge with https://drive.google.com/open?id=1CP_uYV52MKV42Qt7O3TrpzS1sr7JBWPMIWxw4sQV</p>
        </script>


    </head>
    <body>
        <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

        <header>
            <h1>Map Updater <span id='currentPage'></span></h1>
        </header>
        <main id='main'></main>


        <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script> 
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->
    </body>
</html>
