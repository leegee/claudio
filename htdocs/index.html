<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Map Uploader</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>

    <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

    <script>
        var Config = {
            apikey: 'AIzaSyDAdOILIN2SPM_1iPKJMbHd9jOck8H9J7o',
            clientId: '837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com',
            scopes: 'https://www.googleapis.com/auth/fusiontables',
            fusion: {
                name: 'lee-dev',
                countiesTableId: '1CP_uYV52MKV42Qt7O3TrpzS1sr7JBWPMIWxw4sQV',
                sheetNameStem: 'lee-dev-',
                maxRetries: 3
            },
            endpoints: {
                uploadSkus: '/cgi-bin/upload-skus.cgi'
            },
            indexBaseDir: 'temp',
            reLinksFromText: /\bhref=(.)([^/]+?)\/\1/g
        };

        var ENTER = function () {
            gapi.auth.authorize({
                client_id: Config.clientId,
                scope: Config.scopes,
                immediate: true
            }, handleAuthResult);
        };

        var handleAuthResult = function (authResult) {
            console.log('authResult = ', authResult);
            if (authResult && !authResult.error) {
                window.wizard = new Wizard({
                    indexBaseDir: Config.indexBaseDir,
                    indexJsDir: Config.indexBaseDir + new Date().toISOString().replace(/\W/g, '_'),
                    access_token: authResult.access_token
                });
                window.wizard.nextPage();
            } else {
                console.log('Not authorised');
                var el = document.getElementById('authButton');
                // No access token could be retrieved, show the button to start the authorization flow.
                el.addEventListener('click', ENTER);
                el.setAttribute('style', 'display:block');
                window.wizard.gotoPage('manual-auth');
            }
        };

        const authString = function () {
            return 'key=' + Config.apikey + '&access_token=' + window.wizard.state.access_token;
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(),
            );
            return (await response.json()).items;
        }

        var page2 = async function () {
            console.log('Enter page2');
            // window.wizard.fusionTableDetails = await asyncListTables();
            //     window.wizard.nextPage();
            // }

            // var page2 = function () {
            document.getElementById('skusCsv').addEventListener('change', (e) => {
                this.state.skusToProcess = document.getElementById('skusToProcess').value;
                this.state.file = e.target.files[0];
                this.nextPage();
            }, false);
            // document.getElementById('selectFusionTable').addEventListener('click', function () {
            //     var selectList = document.getElementById('fusionTableIds');
            //     window.wizard.state.tableId = selectList.options[ selectList.selectedIndex ].value;
            //     window.wizard.gotoPage('merge');
            // });
        }

        var page3 = async function () {
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => { window.wizard.nextPage() }, false);
            return Promise.resolve();
        }

        /**
        * Before the cx closes, server will respond with HTML status updates.
        */
        var page4 = async function () {
            console.log('Enter page4 to send to CGI');
            var buffer = '',
                data = new FormData(),
                logwindow = document.getElementById('logWindow'),
                request = new XMLHttpRequest(),
                show = (html) => {
                    logwindow.innerHTML = html;
                    logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                }
                ;

            data.append('skus-text', window.wizard.state.skusToProcess);
            data.append('skus-file', window.wizard.state.file);
            data.append('index_js_dir', window.wizard.state.indexJsDir);

            request.onreadystatechange = () => {
                if (request.responseText.length) {
                    show(request.responseText);
                }
                if (request.readyState === XMLHttpRequest.DONE) {
                    console.log('CGI processing and Google processing complete.');
                    window.wizard.gotoPage('review-specific-index');
                    return Promise.resolve();
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadSkus + '?' + authString());
            request.send(data);
        }

        var page6 = function () {
            console.log('page 6: ', window.wizard.state.indexJsDir);
        }

        var reviewSpecificIndex = async function () {
            var response = await window.fetch(
                window.wizard.state.indexJsDir + '/index.js'
            );
            window.wizard.state.indexJs = await response.json();
            // Map the index to something the page can display:
            // ....todo.....
            window.wizard.gotoPage('review-specific-index');
        }

        // Relies upon server auto-indexing (NB .htaccess created in Izel.pm)
        var pageReviewIndexes = async function () {
            var response = await window.fetch(
                this.state.indexBaseDir
            );
            var text = await response.text();
            wizard.state.indexes = _linksFromText(text);
            console.log(wizard.state.indexes);
            this.render();
            // window.wizard.gotoPage('review-indexes');
        }

        var _linksFromText = function (str) {
            var match;
            var rv = [];
            do {
                match = Config.reLinksFromText.exec(str);
                if (match) rv.push(match[2]);
            } while (match);
            return rv;
        }

        var Wizard = function (state) {
            this.state = {
                pageIds: []
            }; // window.history.popstate();?
            Object.keys(state).forEach((key) => {
                this.state[key] = state[key];
            });
            this.pageEl = null;
            this.page = 0;
            this.el = {
                main: document.getElementById('main'),
                pageNumber: document.getElementById('pageNumber')
            };
            this.el.main.setAttribute('style', 'display:block"');
            this.el.pageNumber.setAttribute('style', 'display:block"');
            document.querySelectorAll('script[type="text/mustache"]').forEach((el) => {
                var id = el.id.match(/^page-(\d+)$/)[1];
                this.state.pageIds.push(Number(id));
            });
            this.state.pageIds = this.state.pageIds.sort(function (a, b) { return a > b });
            console.log('Page IDs:', this.state.pageIds);
            window.popstate = (e) => {
                console.log('POPSTATE ', e);
                return false;  //pushstate
            };
        }

        /**
         * Show a numbered page that also has data-page-name attribute that equates to the passed pageName argument,
         * or a specific number.
         *
         * @param {string} pageName - string matching an element's `data-page-name` attribute.
         * @returns void
         */
        Wizard.prototype.gotoPage = function (pageName) {
            var pageNumber = Number(pageName) ? pageName : this.findPageNumber(pageName);
            console.log('Wizard gotoPage, from ', this.page, ' to page ', pageName, ' which I think is ', pageNumber);
            this.nextPage(pageNumber);
        }

        Wizard.prototype.findPageNumber = function (pageName) {
            var rv;
            try {
                rv = Number( document.querySelector('script[type="text/mustache"][data-page-name="' + pageName + '"]').id.match(/^page-(\d+)$/)[1] );
                this.state.pageName = pageName;
                console.log('Found page, set pageName to ', this.state.pageName = pageName);
            } catch (e) {
                console.log('No such page as ', pageName);
                rv = null;
                this.state.pageName = null;
            }
            console.log('FindPageNumber found for page %s page number %d', pageName, rv);
            return rv;
        }

        /**
         * Hides the current page, and processes and shows the template for the element
         * for the page element whose * `id` attribute matches
         * the prefix `page-` suffixed with the incremented page number. If a function
         * exists matching the suffix `page` with the prefix of the page number, it
         * will be called after the template has been processed and displayed.
         *
         * If the numbered page does not exist, the page with the next-highest number is shown.
         *
         * Also, if no arg supplied, tries to find data-next-page='name|number' from the current page.
         *
         * @param {number} [pageNumber] - Optional page number to which to jump.
         * @return void
         */
        Wizard.prototype.nextPage = async function (pageNumber) {
            console.log('Enter Wizard.nextPage');
            if (!pageNumber) {
                this.state.pageName = null; // ?? Check
                console.log('no pageNumber arg');
                var el = document.getElementById('page-' + this.page);
                if (el && el.dataset && el.dataset.nextPage) {
                    pageNumber = this.findPageNumber(el.dataset.nextPage);
                    console.log('set pageNumber from nextPage; is now ', pageNumber);
                } else {
                    console.log('no existing page/with nextPage, ', this.page);
                    pageNumber = Number(this.page) + 1;
                    console.log('inc pageNumber to ', pageNumber);
                }

                console.log('no pageNumber arg');
            }

            this.pageEl = document.getElementById('page-' + pageNumber);
            if (! this.pageEl) {
                for (var i = 0; i < this.state.pageIds.length; i++) {
                    if (this.state.pageIds[i] > pageNumber) {
                        pageNumber = this.state.pageIds[i];
                        this.pageEl = document.getElementById('page-' + pageNumber);
                        break;
                    }
                }
                if (! this.pageEl) {
                    this.el.main.innerHTML = '<h2>Error</h2><p>Could not find the requested page, ' + pageNumber + '</p>';
                    return;
                }
            }

            console.log('Wizard.nextPage from page', this.page, 'to page number ', pageNumber);
            this.page = pageNumber;

            this.render();

            var fns = ['page' + this.page];
            if (this.state.pageName) {
                fns.push( this._antsToCamelCase('page-' + this.state.pageName) );
            }

            for (fn of fns) {
                if (typeof window[fn] === 'function') {
                    var rv =window[fn].call(this, arguments);
                    // var rv = window[fn](arguments);
                    if (typeof rv === 'object' && rv.then && typeof rv.then === 'function') {
                        console.log('Await');
                        try {
                            await rv;
                        } catch (e) {
                            console.error(e);
                        }
                        console.log('Done waiting.');
                    }
                }
            }

            window.location.hash = this.page;
            window.history.pushState( this.state, 'Page '+this.page, window.location.toString() );

            console.log('Page = ', this.page);
        }

        Wizard.prototype.render = function () {
            try {
                this.el.main.innerHTML = Mustache.render(
                    this.pageEl.innerHTML.toString(),
                    { Config: Config, wizard: this }
                );
                this.el.pageNumber.innerText = this.page;
                var links = document.querySelectorAll('[data-goto-page]');
                for (var el of links) {
                    el.onclick = (e) => {
                        window.wizard.gotoPage(e.target.dataset.gotoPage)
                    };
                };
            } catch (e) {
                console.error(e);
            }
        }

        Wizard.prototype._antsToCamelCase = function (str) {
            return str.replace(/-(\w)/g, (_, initial) => {
                return initial.toUpperCase();
            });
        }

    </script>

    <script type='text/mustache' id='page-100' data-page-name='manual-auth'>
        <p>
            <button id='authButton' name='authButton'>Log In</button>
        </p>
    </script>

    <script type='text/mustache' id='page-1'>
        <p>
            We have too much data to fit into a single Fusion table, so this
            app creates several tables and an index which is referenced by
            the map pages.
        </p>
        <ul>
            <li data-goto-page='select-skus'>Uupload SKU geography</lia>
            <li data-goto-page='review-indexes'>Publish previously uploaded SKU geography</li>
        </ul>
    </script>

    <script type='text/mustache' id='page-2' data-page-name='select-skus'>
        <fieldset>
            <legend>Upload SKU Geography</legend>
            <div id='enterSkusToProcess'>
                <p><label for='skusToProess'>Please enter a list of USDA symbols/SKUs to proceess. Separate mulitple values with spaces and/or commas.</p>
                <ul><textarea id='skusToProcess' name='skusToProcess'></textarea>
            </div>
            <div id='selectCsv'>
                <p><label for='skusCsv'>To create a new Fusion Table, select a SKU CSV file from your local machine:</label></p>
                <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
            </div>
            <div id='listFusionTables' style='display:none'>
                <p>Or choose an existing Fusion Table from this list of tables stored in your Google account:</p>
                <select id='fusionTableIds' name='fusionTableIds'>
                    {{#wizard.fusionTableDetails}}
                        <option value='{{tableId}}'>{{name}} - {{description}}</option>
                    {{/wizard.fusionTableDetails}}
                </select>
                <button id='selectFusionTable' name='selectFusionTable'>Choose</button>
            </fieldset>
        </div>
    </script>

    <script type='text/mustache' id='page-3' data-page-name='upload'>
        Page 3.
        <div id='meta'>
            <p>USDA SKUs to process:</p>
            <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button id="upload-skus">Process this SKU/geography file</button>
        <button id="cancel-skus">Cancel</button>
    </script>

    <script type='text/mustache' id='page-4'>
        <p> Creating maps... </p>
        <div id='logWindow'></div>
    </script>

    <script type='text/mustache' id='page-10' data-page-name='review-indexes'>
        <p> Please select an index. </p>
        <ul>
            {{#wizard.state.indexes}}
                <li>{{.}}</li>
            {{/wizard.state.indexes}}
        </ul>
    </script>

    <script type='text/mustache' id='page-11' data-page-name='no-indexes'>
        <p>There are no indexes. Please upload some SKU/geography.</p>
    </script>

    <script type='text/mustache' id='page-20' data-page-name='review-specific-index'>
        {{#wizard.state.indexJs.tableInternalId2googleTableId}}
            <h3><a href="https://fusiontables.google.com/DataSource?docid={{.}}#map:id=3>Map {{}}</a>
        {{/wizard.state.indexJs.tableInternalId2googleTableId}}
    </script>

</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <header>
        <h1>Map Updater
            <span id='pageNumber'>1</span>
        </h1>
    </header>

    <main id='main'>
        <p>
            Welcome to the map making page.
        </p>
        <p>
            Authorising with Google....
        </p>
        <p>
            <button style='display:none' id='authButton' name='authButton'>Log In</button>
        </p>
    </main>


    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

    <script src="https://apis.google.com/js/client.js?onload=ENTER"></script>
</body>

</html>