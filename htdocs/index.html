<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Map Uploader</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>

    <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

    <script>
        var Config, Config_Url = 'Config.js';

        var ENTER = async function () {
            var _ = await window.fetch(Config_Url);
            Config = await _.json();
            gapi.load('client:auth2', initClient);
        };

        function initClient() {
            gapi.client.init({
                'apiKey': Config.apiKey,
                'discoveryDocs': Config.discoveryUrls,
                'clientId': Config.clientId,
                'scope': Config.scopes.join(' ')
            }).then(function () {
                GoogleAuth = gapi.auth2.getAuthInstance();
                GoogleAuth.isSignedIn.listen(updateSigninStatus);
                setSigninStatus();
                document.getElementById('authButton').addEventListener('click', function () {
                    GoogleAuth.isSignedIn.get() ? GoogleAuth.signOut() : GoogleAuth.signIn();
                });
            });
        }

        function updateSigninStatus(isSignedIn) {
            setSigninStatus(isSignedIn);
        }

        function setSigninStatus(isSignedIn) {
            var user = GoogleAuth.currentUser.get();
            var isAuthorized = user.hasGrantedScopes(Config.scopes.join(' '));
            document.getElementById('authButton').innerHTML = isAuthorized? 'Sign out' : 'Sign In';
            if (isAuthorized){
                window.wizard = new Wizard({
                    indexBaseDir: Config.indexBaseDir,
                    indexJsDir: Config.indexBaseDir + new Date().toISOString().replace(/\W/g, '_') + '/',
                    access_token: user.getAuthResponse().access_token
                });
                window.wizard.nextPage('menu');
            }
        }

        var authString = function (accessToken) {
            return 'key=' + Config.apiKey + '&access_token=' + accessToken;
        };

        var pageMenuAfterRender = function () {
            this.hide('footer');

            this.updateStatus = this.updateStatus || function () {
                fetch(Config.endpoints.status + ';' + authString(this.state.access_token)).then( (res) => {
                    return res.json();
                }).then( (json) => {
                    console.table(json);
                    this.el.statusPublished.innerHTML = json.numberOfPublishedSkus;
                    this.el.statusTotal.innerHTML = json.numberOfTotalSkus;
                });
            }

            this.el.statusPublished = this.el.statusPublished || document.getElementById('number-of-published-skus');
            this.el.statusTotal = this.el.statusTotal || document.getElementById('number-of-total-skus');
            this.el.status = this.el.status || document.getElementById('status');
            this.el.status.addEventListener('click', () => {
                this.updateStatus();
            })
            this.updateStatus();
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(this.state.access_token),
            );
            return (await response.json()).items;
        }

        var pageSelectSkusAfterRender = async function () {
            document.getElementById('skusCsv').addEventListener('change', (e) => {
                this.state.file = e.target.files[0];
                this.nextPage('preview-upload');
            }, false);
        }

        var pageCgiSomeSkusBeforeRender = async function () {
            this.state.skusToProcess = document.getElementById('skusToProcess').value;
        };

        var pageCgiSomeSkusAfterRender = async function () {
            this.callAsMethod('cgi', {
                'action': 'publish-some-skus',
                'skus-text': this.state.skusToProcess,
                'index_js_dir': this.state.indexJsDir,
                'recreate_db': 0,
                // 'nextPage': 'review-some-skus'
            });
        };

        var pageUploadDbAfterRender = function () {
            this.callAsMethod('cgi', {
                'action': 'upload-db',
                'skus-text': this.state.skusToProcess,
                'skus-file': this.state.file,
                'index_js_dir': this.state.indexJsDir,
                'nextPage': 'menu' // 'review-specific-index'
            })
        };

        /**
        * Before the cx closes, server will respond with HTML status updates.
        */
        var cgi = async function (args) {
            if (! args || !args.action) {
                throw new Error('No args.action?');
            }

            var buffer = '',
                data = new FormData(),
                logwindow = document.getElementById('log-window'),
                request = new XMLHttpRequest(),
                show = (html) => {
                    logwindow.innerHTML = html;
                    logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                }
            ;

            for (key in args) {
                data.append( key, args[key] );
            }

            request.onreadystatechange = () => {
                if (request.responseText.length) {
                    show(request.responseText);
                }
                if (request.readyState === XMLHttpRequest.DONE) {
                    if (request.status === 200) {
                        if (args.nextPage) {
                            window.wizard.nextPage(args.nextPage, this.state.indexJsDir);
                        }
                        return Promise.resolve();
                    } else {
                        console.error(request);
                        return Promise.reject(request.status);
                    }
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadDb + '?' + authString(this.state.access_token));
            request.send(data);
        }

        var pageRestartPreviousAfterRender = function () {
            this.callAsMethod('cgi', {
                action: 'restart-previous',
                nextPage: 'menu', // 'review-specific-index'
            })
        };

        var pageResumePreviousAfterRender = async function () {
            this.callAsMethod('cgi', {
                action: 'resume-previous',
                nextPage: 'menu' // 'review-specific-index'
            })
        };

        var pagePreviewDbBeforeRender = async function () {
            console.log('Load ', Config.endpoints.previewDb);
            var response = await window.fetch(
                Config.endpoints.previewDb
            );
            var json = await response.json();
            this.callAsMethod(viewIndex, json);
        };

        var publishFusionTable = function(fileId, next) {
            // POST /drive/v2/files/<fusiontable_id or document_id>/permissions HTTP/1.1
            var response = await window.fetch(
                'https://www.googleapis.com/drive/v2/files/' + fileId + '/permissions?' + authString(this.state.access_token),
                {
                    method: 'POST',
                    body: JSON.stringify({"role": "reader","type": "anyone"}),
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                }
            );
            var json = await response.json();
            console.log(json);
            if (next) {
                this.callAsMethod(next, json);
            }
        };

        var pagePreviewDbAfterRender = async function () {
            if (! this.el.publishTables){
                this.el.publishTables = document.getElementById('publish-tableInternalId2googleTableId');
                this.el.publishTables.addEventListener('click', () => {
                Object.keys( this.state.tableInternalId2googleTableId ).forEach( async (iId) => {
                    this.callAsMethod('publishFusionTable', this.state.tableInternalId2googleTableId[iId]);
                });
            });
        }

        var viewIndex = function (json) {
            this.state.skus2ids = [];
            for (var sku in json.sku2tableInternalId) {
                this.state.skus2ids.push({
                    sku,
                    id: json.tableInternalId2googleTableId[ json.sku2tableInternalId[sku] ]
                });
            }
            var ids = {};
            for (var id in json.tableInternalId2googleTableId) {
                var googleTableId = json.tableInternalId2googleTableId[id];
                ids[googleTableId] ++;
            }
            this.state.tableInternalId2googleTableId = Object.keys(ids).sort();
        };

        var pageReviewSpecificIndexBeforeRender = async function (e) {
            if (e instanceof Array) {
                e = e[0]
            }
            if (typeof e === 'string') {
                this.state.jobName = e;
            } else {
                // Called by click event
                this.state.jobName = ('/' + this.state.indexBaseDir + '/' + e.target.innerText).replace(/\/+/g, '/');
            }
            var url = (this.state.jobName + '/index.js').replace(/\/+/g, '/');
            var response = await window.fetch(url);
            var json = await response.json();
            this.callAsMethod(viewIndex, json);
            console.log('Leave pageReviewSpecificIndexBeforeRender with ', this.state.skus2ids)
        }

        // Relies upon server auto-indexing (NB .htaccess created in Izel.pm)
        var pageReviewIndexesBeforeRender = async function () {
            var response = await window.fetch( this.state.indexBaseDir );
            var text = await response.text();
            this.state.indexes = _linksFromText(text);
        }

        var _linksFromText = function (str) {
            var m,
                rv = [],
                regexp = /\bhref=(.)([^/]+?)\/\1/g
            ;
            while (m = regexp.exec(str)) {
                rv.push( m[2])
            }
            return rv;
        }

        /**
         * Pages are `script` elements of `type` `text/handlebars`,
         *  with a `id` attribute.
         *
         * @example
         *  <script type=<script type='text/handlebars' id='manual-auth'> ...
         *
         * Pages are displayed via `Wizard.nextPage(:pageName)`.
         *
         * ## Data for Page Templates
         *
         * The Wizard supplies itself as `wizard`.
         *
         * ## Linking Within Pages
         *
         * Before templates are displayed, hyperlinks are added to any element that has an attribute
         * `data-goto-page`: the attribute's value can be a page name.
         *
         * ## Code For Pages
         *
         * Before a page is rendered, the Wizard will try to call a function with a camel-cased version
         * of the ant-cased page name, prefixed with the word 'page'.
         *
         * @example
         *  <script type=<script type='text/handlebars' id='manual-auth'> ...
         *  function pageManualAuth () { ...
         *
         * After a page is displayed, the Wizard will try to call a function with the same name, and the
         * suffix 'AfterRender`:
         *
         *  function pageManualAuthAfterRender () { ...
         *
         * Note that a suffix `BeforeRender` may be added to the function called before the page is rendered.
         *
         *  function pageManualAuthBeforeRender () { ...
         *
         * All three functions are called in the context of the Wizard.
         *
         * Yeah, @decorators would be nice without trainspoiling.
         *
         */
        var Wizard = function (state) {
            this.state = {};
                // pageName: null,
                // lastPageName: null
            Object.keys(state).forEach((key) => {
                this.state[key] = state[key];
            });
            this.pageEl = null;
            this.el = {
                main: document.getElementById('main'),
                footer: document.getElementById('footer'),
                ctrlMenu: document.getElementById('ctrl-menu'),
                ctrlNext: document.getElementById('ctrl-next'),
                ctrlBack: document.getElementById('ctrl-back'),
                ctrlCancel: document.getElementById('ctrl-cancel'),
                spinner: document.getElementById('spinner'),
            };
            this.hide('spinner');
            this.el.ctrlMenu.addEventListener('click', () => {
                this.nextPage('menu');
            });
            this.el.main.setAttribute('style', 'display:block"');
            // if (window.history.state && window.history.state.pageName) {
            //     this.state = window.history.state;
            //     this.nextPage(this.state.pageName);
            // }
        }

        Wizard.prototype.callAsMethod = function (method, ...args) {
            console.log('callAsMethod ', method, args);
            if (typeof method === 'string') {
                method = window[method];
            }
            return method.apply(this, args);
        }

        Wizard.prototype.nextPage = async function (pageName, ...passOnArgs) {
            console.log('Enter Wizard.nextPage with %s -----------------------------------------', pageName);

            if (this.state.lastPageName) {
                await this._execute('page-' + this.state.pageName + '-on-leave', passOnArgs);
            }

            // If not told where to go, check the current template for instructions
            if (! pageName && this.pageEl.nextPageName) {
                pageName = this.pageEl.nextPageName;
                console.log('Got next-page pageName from data-next-page: ', pageName);
            }

            this.pageEl = document.querySelector('script[type="text/handlebars"][id="' + pageName + '"]');
            if (! this.pageEl) {
                this.el.main.innerHTML = '<h2>Error</h2><p>Could not find the requested page, ' + pageName + '</p>';
                return;
            }
            this.state.nextPageName = this.pageEl.dataset.nextPage || null;

            this.state.pageName = pageName;

            var fnNames = [
                'page-' + this.state.pageName,
                'page-' + this.state.pageName + '-before-render'
            ];

            await this._execute(fnNames, passOnArgs);

            if (this.state.pageName === 'menu') {
                this.hide('footer');
            } else {
                this.show('footer');
            }

            this.render();

            if (this.state.pageName) {
                await this._execute('page-' + this.state.pageName + '-after-render', passOnArgs);
            }

            this.state.lastPageName = this.state.pageName;

            window.location.hash = this.state.pageName;
            window.history.pushState( this.state, 'Page '+this.state.pageName, window.location.toString() );

            console.log('Leave nextPage with page = ', this.state.pageName);
        }

        Wizard.prototype._execute = async function (fns, passOnArgs) {
            console.log('Wizard._execute', fns);
            if (! fns) return;
            var promises = [];
            if (typeof fns === 'string') fns = [fns];
            for (f of fns) {
                var fn = this._antsToCamelCase(f);
                console.log('Look for ', fn);
                if (typeof window[fn] === 'function') {
                    console.log('Found %s, calling....', fn);
                    promises.push( window[fn].call(this, passOnArgs) );
                    console.log('...called  %s', fn);
                } else {
                    console.log('Did not find ', fn);
                }
            }
            if (promises) {
                console.log('Waiting on ', promises.length, promises);
                await Promise.all(promises);
                console.log('Done all promises');
            }
            else {
                console.log('Leave now');
                return Promise.resolve();
            }
        };

        // {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
        Handlebars.registerHelper('wizardIncludeTemplate', function(templateId) {
            var html = Handlebars.compile(
                document.getElementById(templateId).innerHTML.toString()
            )(
                { wizard: this.wizard }
            );
            return new Handlebars.SafeString(html);
        });

        // Wizard.prototype.includeTemplate = function () {
        //     console.log('-------', this);
        // }

        Wizard.prototype.render = function () {
            console.log('Enter render');
            try {
                // this.el.main.innerHTML = handlebars.render(
                //     this.pageEl.innerHTML.toString(),
                //     { wizard: this }
                // );
                // No caching:
                this.el.main.innerHTML = Handlebars.compile(
                    this.pageEl.innerHTML.toString()
                )(
                    { wizard: this }
                );
                var links = document.querySelectorAll('[data-goto-page]');
                for (var el of links) {
                    el.setAttribute('style',
                        el.getAttribute('style') + ';cursor:pointer;'
                    );
                    el.onclick = (e) => {
                        this.show('spinner');
                        this.nextPage(e.target.dataset.gotoPage, e);
                        this.hide('spinner');
                    };
                };
            } catch (e) {
                console.error(e);
            }
        }

        Wizard.prototype.show = function (id) {
            this.el[id].setAttribute('style', 'display: block');
        };

        Wizard.prototype.hide = function (id) {
            this.el[id].setAttribute('style', 'display: none');
        };

        Wizard.prototype._antsToCamelCase = function (str) {
            return str.replace(/-(\w)/g, (_, initial) => {
                return initial.toUpperCase();
            });
        }
    </script>

    <script type='text/handlebars' id='menu'>
        <div id='status'>
            Published <span id='number-of-published-skus'></span> of
            <span id='number-of-total-skus'></span> known SKUs.
        </div>
        <ul>
            <li data-goto-page='select-some-skus'>Publish some SKUs</lia>
            <li data-goto-page='resume-previous'>Create maps for new SKUs</lia>
            <li data-goto-page='restart-previous'>Restart the last job</lia>
            <li data-goto-page='preview-db'>Preview and publish SKUs already uploaded to Google</li>
            <!-- li data-goto-page='review-indexes'>Publish previously uploaded SKU geography</li -->
        </ul>
        <ul>
            <li data-goto-page='select-skus'>Re-initialise - wipe the DB and upload a new SKU-geography CSV.</lia>
        </ul>
    </script>

    <script type='text/handlebars'id='select-skus'>
        <h2>Upload SKU Geography</h2>
        <div id='selectCsv'>
            <p><label for='skusCsv'>From your local machine, select the CSV file that maps all SKU to all FIPS.</label></p>
            <p>Later, you can choose for which SKU to publish maps.</p>
            <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
        </div>
    </script>

    <script type='text/handlebars' id='preview-upload'>
        <h2>Does this look right?</h2>
        <p>USDA SKUs to process:</p>
        <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button data-goto-page="upload-db">Process this SKU/geography file?</button>
    </script>

    <script type='text/handlebars' id='preview-upload'>
        <h2>Does this look right?</h2>
        <p>USDA SKUs to process:</p>
        <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button data-goto-page="upload-db">Process this SKU/geography file?</button>
    </script>

    <script type='text/handlebars' id='upload-db'>
        <h2>Creating Database... </h2>
        <div id='log-window'></div>
    </script>

    <script type='text/handlebars' id='select-some-skus'>
        <p>
            <label for='skusToProcess'>Please enter a list of USDA symbols/SKUs to proceess.
                Separate mulitple values with non-alphanumeric characters (comma, space, bar, etc).
            </label>
        </p>
        <p>
            <textarea id='skusToProcess' name='skusToProcess'></textarea>
        </p>
        <p>
            <button data-goto-page='cgi-some-skus'>Proceed</button>
    </script>

    <script type='text/handlebars' id='cgi-some-skus'>
        <h2>Working on some SKUs</h2>
        <div id='log-window'><p>Publishing some SKUs.</p></div>
    </script>

    <script type='text/handlebars' id='publish-tables-and-skus'>
        <h3>Publish Maps</h3>
        <p>
            <button id='publish-tableInternalId2googleTableId'>Publish all Fusion Tables</button>
        </p>
        <ul>
            {{#wizard.state.tableInternalId2googleTableId}}
                <li><a id='tableId' target='_new' href='https://fusiontables.google.com/DataSource?docid={{.}}'>{{.}}</a></li>
            {{/wizard.state.tableInternalId2googleTableId}}
        </ul>
        <h3>SKU Map Previews</h3>
        <ul class='skus'>
            {{#wizard.state.skus2ids}}
                <li>
                    <a target='_new' href='preview-map.html#{{sku}}'>
                        {{sku}}
                    </a>
                </li>
            {{/wizard.state.skus2ids}}
        </ul>
    </script>

    <script type='text/handlebars' id='preview-db'>
        <h2>SKUs So Far</h2>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

    <script type='text/handlebars' id='restart-previous'>
        <h2>Creating Maps</h2>
        <div id='log-window'><p>Resuming the previous job from scratch.</p></div>
    </script>

    <script type='text/handlebars' id='resume-previous'>
        <h2>Creating Maps</h2>
        <div id='log-window'><p>Resuming the previous job.</p></div>
    </script>

    <script type='text/handlebars' id='review-indexes'>
        <h2>Please select an index</h2>
        {{window.wizard.state.indexes}}
        <ul>
            {{#wizard.state.indexes}}
                <li data-goto-page='review-specific-index'>{{.}}</li>
            {{/wizard.state.indexes}}
        </ul>
    </script>

    <script type='text/handlebars' id='no-indexes'>
        <h2>There are no indexes.</h2>
        <p>Please upload some SKU/geography.</h2>
    </script>

    <script type='text/handlebars' id='review-some-skus'>
        <h2>Your New SKU Maps</h2>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

    <script type='text/handlebars' id='review-specific-index'>
        <h2>{{wizard.state.jobName}}</h2>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <header>
        <h1>Map Updater</h1>
    </header>

    <main id='main'>
        <h2>Welcome to the map making page.</h2>
        <p>
            Please authorise this app and sign-in to continue.
        </p>
        <p>
            <button id='authButton' name='authButton'>Log In</button>
        </p>
    </main>

    <footer id='footer' style='display:none'>
        <div style='width:50%;float:left;'>
            <button style='display:none' id='ctrl-cancel'>Cancel</button>
        </div>
        <div style='width:50%;float:left;text-align:right'>
                <button id='ctrl-menu'>Menu</button>
            <button style='display:none' id='ctrl-back'>Back</button>
            <button style='display:none' id='ctrl-next'>Next</button>
        </div>
    </footer>


    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

        <div id="spinner" class="loader" style="display:none">Loading...</div>
        <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};ENTER()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
    </body>

</html>