<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Map Uploader</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>

    <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

    <script>
        var Config, Config_Url = 'Config.js';

        var ENTER = async function () {
            console.log('ENTER');

            var _ = await window.fetch(Config_Url);
            Config = await _.json();
            gapi.load('client:auth2', initClient);
        };

        function initClient() {
            gapi.client.init({
                'apiKey': Config.apiKey,
                'discoveryDocs': Config.discoveryUrls,
                'clientId': Config.clientId,
                'scope': Config.scopes.join(' ')
            }).then(function () {
                document.getElementById('spinner').setAttribute('style', 'display:none');
                GoogleAuth = gapi.auth2.getAuthInstance();
                GoogleAuth.isSignedIn.listen(updateSigninStatus);
                setSigninStatus();
                document.getElementById('authButton').addEventListener('click', function () {
                    GoogleAuth.isSignedIn.get() ? GoogleAuth.signOut() : GoogleAuth.signIn();
                });
            });
        }

        function updateSigninStatus(isSignedIn) {
            setSigninStatus(isSignedIn);
        }

        function setSigninStatus(isSignedIn) {
            var user = GoogleAuth.currentUser.get();
            var isAuthorized = user.hasGrantedScopes(Config.scopes.join(' '));
            var button = document.getElementById('authButton');
            button.innerHTML = isAuthorized? 'Sign out' : 'Sign In';
            button.disabled = false;
            if (isAuthorized){
                window.wizard = new Wizard({
                    indexBaseDir: Config.indexBaseDir,
                    indexJsDir: Config.indexBaseDir + new Date().toISOString().replace(/\W/g, '_') + '/',
                    access_token: user.getAuthResponse().access_token
                });
                window.wizard.nextPage('menu');
            }
        }

        var authString = function (accessToken) {
            return 'key=' + Config.apiKey + '&access_token=' + accessToken;
        };

        var pageMenuAfterRender = function () {
            this.hide('footer');

            this.updateStatus = this.updateStatus || function () {
                fetch(Config.endpoints.status + ';' + authString(this.state.access_token)).then( (res) => {
                    return res.json();
                }).then( (json) => {
                    console.table(json);
                    try {
                        document.getElementById('number-of-mapped-skus').innerHTML = Number(json.numberOfMappedSkus).toLocaleString();
                        document.getElementById('number-of-total-skus').innerHTML = Number(json.numberOfTotalSkus).toLocaleString();
                    } catch (e) {}
                });
            }
            document.getElementById('status').addEventListener('click', () => {
                this.updateStatus();
            })
            this.updateStatus();
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(this.state.access_token),
            );
            return (await response.json()).items;
        }

        var pageSelectSomeSkusAfterRender = function () {
            // alert(123);
        }

        var pageSelectAugmentDbAfterRender = async function () {
            document.getElementById('skusCsvAugment').addEventListener('change', (e) => {
                this.state.file = e.target.files[0];
                this.nextPage('augment-db');
            }, false);
        }

        var pageSelectSkusAfterRender = async function () {
            document.getElementById('skusCsv').addEventListener('change', (e) => {
                this.state.file = e.target.files[0];
                this.nextPage('preview-upload');
            }, false);
        }

        var pageWipeGoogleDataAfterRender = async function () {
            this.callAsMethod('cgi', {
                'action': 'wipe-google-data',
                logWindowId: 'wipe-google-data-log'
            });
        };

        var pageMapSomeSkusBeforeRender = async function () {
            this.state.skusToProcess = document.getElementById('skusToProcess').value;
        };

        var pageMapSomeSkusAfterRender = async function () {
            this.callAsMethod('cgi', {
                'action': 'map-some-skus',
                'skus-text': this.state.skusToProcess,
                logWindowId: 'map-some-skus-log'
            });
        };

        var pageAugmentDbAfterRender = function () {
            this.callAsMethod('cgi', {
                'action': 'augment-db',
                'skus-file': this.state.file,
                'logWindowId': 'augment-db-log'
                // 'nextPage': 'menu' // 'review-specific-index'
            })
        };

        var pageUploadDbAfterRender = function () {
            this.callAsMethod('cgi', {
                'action': 'upload-db',
                'skus-file': this.state.file,
                'logWindowId': 'upload-db-cgi'
                // 'nextPage': 'menu' // 'review-specific-index'
            })
        };

        /**
        * Before the cx closes, server will respond with HTML status updates.
        */
        var cgi = async function (args) {
            return new Promise((resolve, reject) => {
                if (! args || !args.action || !args.logWindowId) {
                    throw new Error('No args, action || logWindowId?');
                }

                console.log('Log to ', args.logWindowId);

                var buffer = '',
                    data = new FormData(),
                    logwindow = document.getElementById(args.logWindowId),
                    request = new XMLHttpRequest(),
                    show = (html) => {
                        logwindow.innerHTML = html;
                        logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                    }
                ;

                // logwindow.setAttribute('style', '   overflow:scroll; height: 20em; font-family: monospace; white-space: pre; ');

                for (key in args) {
                    data.append( key, args[key] );
                }

                request.onreadystatechange = () => {
                    if (request.responseText.length) {
                        show(request.responseText);
                    }
                    if (request.readyState === XMLHttpRequest.DONE) {
                        if (request.status === 200) {
                            if (args.nextPage) {
                                window.wizard.nextPage(args.nextPage, this.state.indexJsDir);
                            }
                            resolve();
                        } else {
                            console.error(request);
                            reject(request.status);
                        }
                    }
                }
                request.open('POST', Config.endpoints.uploadDb + '?' + authString(this.state.access_token));
                request.send(data);
            });
        }

        var publishFusionTable = async function(tableId, next) {
            // POST /drive/v2/files/<fusiontable_id or document_id>/permissions HTTP/1.1
            var response = await window.fetch(
                Config.endpoints.local + '?action=publish;'
                    + authString(this.state.access_token)
                    + ';tableId=' + tableId
            );
                // 'https://www.googleapis.com/drive/v2/files/' + tableId + '/permissions?' + authString(this.state.access_token),
                // {
                //     method: 'POST',
                //     body: JSON.stringify({"role": "reader","type": "anyone"}),
                //     headers: {
                //         'Accept': 'application/json',
                //         'Content-Type': 'application/json'
                //     }
                // }
            var json = await response.json();
            console.log(json);
            if (next) {
                this.callAsMethod(next, json);
            }
        };

        var pagePreviewDbBeforeRender = async function () {
            var response = await window.fetch(
                Config.endpoints.local + '?action=preview-db'
            );
            var json = await response.json();
            this.callAsMethod(viewIndex, json);
        };

        var setCssClass = function (internalTableId, isPublished) {
            var style = document.createElement('style');
            style.type = 'text/css';
            document.getElementsByTagName('head')[0].appendChild(style);
            var str = 'FT_' + internalTableId + '::before { content: "'
            +  (internalTableId === 0 ? '☑' : '☐')
            + '"}';
            style.sheet.insertRule( str, 0 );
        }

        var pagePreviewDbAfterRender = async function () {
            var todo = 0;

            Object.keys(this.state.googleTableId2published).forEach( (id) => {
                if (this.state.googleTableId2published[id]===1) {
                    todo++;
                }
            });

            Object.keys(this.state.tableInternalId2googleTableId).forEach( (iId) => {
                this.callAsMethod('setCssClass', iId, this.state.tableInternalId2published[iId]);
            });

            if (! todo) {
                var el = document.getElementById('publish-tableInternalId2googleTableId');
                el.outerHTML = '';
                delete el;
            }

            if (! this.el.publishTables){
                this.el.publishTables = document.getElementById('publish-tableInternalId2googleTableId');
                if (this.el.publishTables) {
                    this.el.publishTables.addEventListener('click', () => {
                        var promises = [];
                        this.el.publishTables.disabled = true;
                        console.log('Publish: ', this.state.googleTableId2published);
                        Object.keys( this.state.googleTableId2published ).forEach( async (tableId) => {
                            if (this.state.googleTableId2published[tableId] === 0) {
                                console.log('Publish ', tableId);
                                promises.push(this.callAsMethod('publishFusionTable', tableId));
                            } else {
                                console.log('Have already published ', tableId);
                            }
                        });
                        Promise.all(promises).then( () => {
                            alert('Published ' + promises.length + ' tables');
                        })
                    });
                }
            }
        }

        var viewIndex = function (json) {
            console.log('___________________________\n', JSON.stringify(json, undefined, 4));
            Object.keys(json).forEach( (key) => {
                this.state[key] = json[key];
            });
        };

        // var pageReviewSpecificIndexBeforeRender = async function (e) {
        //     if (e instanceof Array) {
        //         e = e[0]
        //     }
        //     if (typeof e === 'string') {
        //         this.state.jobName = e;
        //     } else {
        //         // Called by click event
        //         this.state.jobName = ('/' + this.state.indexBaseDir + '/' + e.target.innerText).replace(/\/+/g, '/');
        //     }
        //     var url = (this.state.jobName + '/index.js').replace(/\/+/g, '/');
        //     var response = await window.fetch(url);
        //     var json = await response.json();
        //     this.callAsMethod(viewIndex, json);
        //     console.log('Leave pageReviewSpecificIndexBeforeRender with ', this.state.skus2ids)
        // }

        var _linksFromText = function (str) {
            var m,
                rv = [],
                regexp = /\bhref=(.)([^/]+?)\/\1/g
            ;
            while (m = regexp.exec(str)) {
                rv.push( m[2])
            }
            return rv;
        }

        /**
         * Pages are `script` elements of `type` `text/handlebars`,
         *  with a `id` attribute.
         *
         * @example
         *  <script type=<script type='text/handlebars' id='manual-auth'> ...
         *
         * Pages are displayed via `Wizard.nextPage(:pageName)`.
         *
         * ## Data for Page Templates
         *
         * The Wizard supplies itself as `wizard`.
         *
         * ## Linking Within Pages
         *
         * Before templates are displayed, hyperlinks are added to any element that has an attribute
         * `data-goto-page`: the attribute's value can be a page name.
         *
         * ## Code For Pages
         *
         * Before a page is rendered, the Wizard will try to call a function with a camel-cased version
         * of the ant-cased page name, prefixed with the word 'page'.
         *
         * @example
         *  <script type=<script type='text/handlebars' id='manual-auth'> ...
         *  function pageManualAuth () { ...
         *
         * After a page is displayed, the Wizard will try to call a function with the same name, and the
         * suffix 'AfterRender`:
         *
         *  function pageManualAuthAfterRender () { ...
         *
         * Note that a suffix `BeforeRender` may be added to the function called before the page is rendered.
         *
         *  function pageManualAuthBeforeRender () { ...
         *
         * All three functions are called in the context of the Wizard.
         *
         * Yeah, @decorators would be nice without trainspoiling.
         *
         */
        var Wizard = function (state) {
            this.state = {};
                // pageName: null,
                // lastPageName: null
            Object.keys(state).forEach((key) => {
                this.state[key] = state[key];
            });
            this.pageEl = null;
            this.el = {
                main: document.getElementById('main'),
                footer: document.getElementById('footer'),
                ctrlMenu: document.getElementById('ctrl-menu'),
                ctrlNext: document.getElementById('ctrl-next'),
                ctrlBack: document.getElementById('ctrl-back'),
                ctrlCancel: document.getElementById('ctrl-cancel'),
                spinner: document.getElementById('spinner'),
            };
            this.hide('spinner');
            this.el.ctrlMenu.addEventListener('click', () => {
                this.nextPage('menu');
            });
            this.el.main.setAttribute('style', 'display:block"');
            // if (window.history.state && window.history.state.pageName) {
            //     this.state = window.history.state;
            //     this.nextPage(this.state.pageName);
            // }
        }

        Wizard.prototype.callAsMethod = function (method, ...args) {
            if (typeof method === 'string') {
                method = window[method];
            }
            return method.apply(this, args);
        }

        Wizard.prototype.nextPage = async function (pageName, ...passOnArgs) {
            console.log('Enter Wizard.nextPage with %s -----------------------------------------', pageName);

            if (this.state.lastPageName) {
                await this._execute('page-' + this.state.pageName + '-on-leave', passOnArgs);
            }

            // If not told where to go, check the current template for instructions
            if (! pageName && this.pageEl.nextPageName) {
                pageName = this.pageEl.nextPageName;
                console.log('Got next-page pageName from data-next-page: ', pageName);
            }

            this.pageEl = document.querySelector('script[type="text/handlebars"][id="' + pageName + '"]');
            if (! this.pageEl) {
                this.el.main.innerHTML = '<h2>Error</h2><p>Could not find the requested page, ' + pageName + '</p>';
                return;
            }
            this.state.nextPageName = this.pageEl.dataset.nextPage || null;

            this.state.pageName = pageName;

            var fnNames = [
                'page-' + this.state.pageName,
                'page-' + this.state.pageName + '-before-render'
            ];

            await this._execute(fnNames, passOnArgs);

            if (this.state.pageName === 'menu') {
                this.hide('footer');
            } else {
                this.show('footer');
            }

            this.render();

            if (this.state.pageName) {
                await this._execute('page-' + this.state.pageName + '-after-render', passOnArgs);
            }

            this.state.lastPageName = this.state.pageName;

            window.location.hash = this.state.pageName;
            window.history.pushState( this.state, 'Page '+this.state.pageName, window.location.toString() );

            console.log('Leave nextPage with page = ', this.state.pageName);
        }

        Wizard.prototype._execute = async function (fns, passOnArgs) {
            console.log('Wizard._execute', fns);
            if (! fns) return;
            var promises = [];
            if (typeof fns === 'string') fns = [fns];
            for (f of fns) {
                var fn = this._antsToCamelCase(f);
                console.log('Look for ', fn);
                if (typeof window[fn] === 'function') {
                    console.log('Found %s, calling....', fn);
                    promises.push( window[fn].call(this, passOnArgs) );
                    console.log('...called  %s', fn);
                } else {
                    console.log('Did not find ', fn);
                }
            }
            if (promises) {
                console.log('Waiting on ', promises.length, promises);
                await Promise.all(promises);
                console.log('Done all promises');
            }
            else {
                console.log('Leave now');
                return Promise.resolve();
            }
        };

        Handlebars.registerHelper('skuClass', function(tableInternalId) {
            return new Handlebars.SafeString('FT_' + this.state.tableInternalId2published[tableInternalId]);
        });

        // {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
        Handlebars.registerHelper('wizardIncludeTemplate', function(templateId) {
            var html = Handlebars.compile(
                document.getElementById(templateId).innerHTML.toString()
            )(
                { wizard: this.wizard }
            );
            return new Handlebars.SafeString(html);
        });

        Wizard.prototype.render = function () {
            console.log('Enter render');
            try {
                // this.el.main.innerHTML = handlebars.render(
                //     this.pageEl.innerHTML.toString(),
                //     { wizard: this }
                // );
                // No caching:
                this.el.main.innerHTML = Handlebars.compile(
                    this.pageEl.innerHTML.toString()
                )(
                    { wizard: this }
                );
                window.scrollTo(0,0);
                var links = document.querySelectorAll('[data-goto-page]');
                for (var el of links) {
                    el.setAttribute('style',
                        el.getAttribute('style') + ';cursor:pointer;'
                    );
                    el.onclick = async (e) => {
                        this.show('spinner');
                        await this.nextPage(e.target.dataset.gotoPage, e);
                        this.hide('spinner');
                    };
                };
            } catch (e) {
                console.error(e);
            }
        }

        Wizard.prototype.show = function (id) {
            this.el[id].setAttribute('style', 'display: block');
        };

        Wizard.prototype.hide = function (id) {
            this.el[id].setAttribute('style', 'display: none');
        };

        Wizard.prototype._antsToCamelCase = function (str) {
            return str.replace(/-(\w)/g, (_, initial) => {
                return initial.toUpperCase();
            });
        }
    </script>

    <script type='text/handlebars' id='menu'>
        <div id='status'>
            Mapped <span id='number-of-mapped-skus'>[-]</span> of
            <span id='number-of-total-skus'>[-]</span> known SKUs.
        </div>
        <p>
            This program allows you to create a database of FIPs and SKUS,
            from which you can create Google Fusion Tables, which you
            must then choose to publish. Once published, they site's main
            map page will seem them in the database.
        </p>
        <ul>
            <li data-goto-page='select-some-skus'>Create maps for some SKUs (prepare some stock)</lia>
            <li data-goto-page='preview-db'>Publish uploaded SKUs (publish some prepared stock)</li>
        </ul>
        <ul>
            <li data-goto-page='wipe-google-data'>Wipe Fusion Table data.</li>
            <li data-goto-page='select-augment-db'>Add another SKU-geography CSV (update distributions)</lia>
            <li data-goto-page='select-skus'>Start again - wipe the DB, delete all Fusion Tables, and upload a new SKU-geography CSV.</lia>
        </ul>
    </script>

    <script type='text/handlebars'id='select-augment-db'>
        <h2>Upload SKU Geography To Augment Database</h2>
        <div id='selectCsv'>
            <p><label for='skusCsvAugment'>From your local machine, select the CSV file that maps all SKU to all FIPS.</label></p>
            <p>Later, you can choose for which SKU to publish maps.</p>
            <p><input type='file' name='skusCsvAugment' id='skusCsvAugment' placeholder='SKUs CSV' type='.csv'></p>
        </div>
    </script>

    <script type='text/handlebars'id='select-skus'>
        <h2>Upload SKU Geography</h2>
        <div id='selectCsv'>
            <p><label for='skusCsv'>From your local machine, select the CSV file that maps all SKU to all FIPS.</label></p>
            <p>Later, you can choose for which SKU to create maps.</p>
            <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
        </div>
    </script>

    <script type='text/handlebars' id='preview-upload'>
        <h2>Does this look right?</h2>
        <p>USDA SKUs to process:</p>
        <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button data-goto-page="upload-db">Process this SKU/geography file?</button>
    </script>

    <script type='text/handlebars' id='wipe-google-data'>
        <h2>Removing Fusion Table data... </h2>
        <div class='log-window' id='wipe-google-data-log'></div>
    </script>

    <script type='text/handlebars' id='augment-db'>
        <h2>Augmenting Database... </h2>
        <div class='log-window' id='augment-db-log'></div>
    </script>

    <script type='text/handlebars' id='upload-db'>
        <h2>Creating Database... </h2>
        <div class='log-window' id='upload-db-log'></div>
    </script>

    <script type='text/handlebars' id='select-some-skus'>
        <p>
            <label for='skusToProcess'>Please enter a list of USDA symbols/SKUs to proceess.
                Separate mulitple values with non-alphanumeric characters (comma, space, bar, etc).
                You will be informed of duplicate and invalid SKUs.
            </label>
        </p>
        <p>
            <textarea id='skusToProcess' name='skusToProcess'></textarea>
        </p>
        <p>
            <button data-goto-page='map-some-skus'>Proceed</button>
    </script>

    <script type='text/handlebars' id='map-some-skus'>
        <h2>Working on some SKUs</h2>
        <div class='log-window' id='map-some-skus-log'><p>Talking to the server....</p></div>
    </script>

    <script type='text/handlebars' id='publish-tables-and-skus'>
        <h3>Publish Maps</h3>
        <p>
            <button id='publish-tableInternalId2googleTableId'>Publish all Fusion Tables</button>
        </p>
        <h4>Google Fusion Tables</h4>
        <ul>
            {{#each wizard.state.tableInternalId2googleTableId}}
                <li><a class='FT_{{@key}}' target='_new' href='https://fusiontables.google.com/DataSource?docid={{this}}'>{{this}}</a></li>
            {{/each}}
        </ul>
        <h3>SKU Maps</h3>
        <ul class='skus'>
            {{#each wizard.state.sku2tableInternalId}}
                <!-- if lookup tableInternalId2published this  -->
                <li><a class='FT_{{this}}' target='_new' href='preview-map.html#{{@key}}' title='In {{this}}'>{{@key}}</a></li>
            {{/each}}
        </ul>
    </script>

    <script type='text/handlebars' id='preview-db'>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

    <!--
    <script type='text/handlebars' id='restart-previous'>
        <h2>Creating Maps</h2>
        <div class='log-window'><p>Resuming the previous job from scratch.</p></div>
    </script>

    <script type='text/handlebars' id='resume-previous'>
        <h2>Creating Maps</h2>
        <div class='log-window'><p>Resuming the previous job.</p></div>
    </script>

    <script type='text/handlebars' id='review-some-skus'>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>
    -->

</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <header>
        <h1>Map Updater</h1>
    </header>

    <main id='main'>
        <h2>Welcome to the map making page.</h2>
        <p>
            Please authorise this app and sign-in to continue.
        </p>
        <p>
            <button disabled='true' id='authButton' name='authButton'>Contacting Google...</button>
        </p>
    </main>

    <footer id='footer' style='display:none'>
        <div style='width:50%;float:left;'>
            <button style='display:none' id='ctrl-cancel'>Cancel</button>
        </div>
        <div style='width:50%;float:left;text-align:right'>
                <button id='ctrl-menu'>Menu</button>
            <button style='display:none' id='ctrl-back'>Back</button>
            <button style='display:none' id='ctrl-next'>Next</button>
        </div>
    </footer>


    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

        <div id="spinner" class="loader">Loading...</div>
        <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};ENTER()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
    </body>

</html>