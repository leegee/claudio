<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Map Uploader</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>

    <meta name="google-signin-client_id" content="837054515213-gja7o8fkcc63vge1noitlu39ijjgrmtu.apps.googleusercontent.com">

    <style>
        ul.skus {
            display: block;
            padding-left: 0;
            margin-left: 1em;
            text-align: justify;
            text-align-last: center;
        }
        ul.skus li {
            display: inline;
            padding-left: 0;
            margin-left: 0;
            margin-right: 1em;
            list-style: none;
        }
    </style>

    <script>
        var Config, Config_Url = 'Config.js';

        var ENTER = async function () {
            var _ = await fetch(Config_Url);
            Config = await _.json();
            gapi.auth.authorize({
                client_id: Config.clientId,
                scope: Config.scopes,
                immediate: true
            }, handleAuthResult);
        };

        var handleAuthResult = function (authResult) {
            console.log('authResult = ', authResult);
            if (authResult && !authResult.error) {
                window.wizard = new Wizard({
                    indexBaseDir: Config.indexBaseDir,
                    indexJsDir: Config.indexBaseDir + new Date().toISOString().replace(/\W/g, '_') + '/',
                    access_token: authResult.access_token
                });
                window.wizard.nextPage('intro');
            } else {
                console.log('Not authorised');
                var el = document.getElementById('authButton');
                // No access token could be retrieved, show the button to start the authorization flow.
                el.addEventListener('click', ENTER);
                el.setAttribute('style', 'display:block');
                window.wizard.nextPage('manual-auth');
            }
        };

        const authString = function (accessToken) {
            return 'key=' + Config.apiKey + '&access_token=' + accessToken;
        };

        var asyncListTables = async function () {
            const response = await window.fetch(
                'https://www.googleapis.com/fusiontables/v2/tables?' + authString(this.state.access_token),
            );
            return (await response.json()).items;
        }

        var pageSelectSkusAfterRender = async function () {
            console.log('Enter page2-------------------------------');
            // window.wizard.fusionTableDetails = await asyncListTables();
            //     window.wizard.nextPage();
            // }

            document.getElementById('skusCsv').addEventListener('change', (e) => {
                this.state.skusToProcess = document.getElementById('skusToProcess').value;
                this.state.file = e.target.files[0];
                this.nextPage('preview-upload');
            }, false);
            // document.getElementById('selectFusionTable').addEventListener('click', function () {
            //     var selectList = document.getElementById('fusionTableIds');
            //     window.wizard.state.tableId = selectList.options[ selectList.selectedIndex ].value;
            //     window.wizard.nextPage('merge');
            // });
        }

        var pagePreviewUploadAfterRender = function () {
            console.log('Enter uploadAfterRender');
            document.getElementById('cancel-skus').addEventListener('click', document.location.reload, false);
            document.getElementById('upload-skus').addEventListener('click', () => { window.wizard.nextPage('upload-skus') }, false);
        }

        /**
        * Before the cx closes, server will respond with HTML status updates.
        */
        var pageUploadSkusAfterRender = async function () {
            console.log('Enter upload to send to CGI');
            var buffer = '',
                data = new FormData(),
                logwindow = document.getElementById('logWindow'),
                request = new XMLHttpRequest(),
                show = (html) => {
                    logwindow.innerHTML = html;
                    logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                }
            ;
            logwindow.setAttribute('style', 'position:relative;overflow:auto;height:20em;font-family: monospace; white-space: pre;');

            data.append('action', 'upload-skus');
            data.append('skus-text', this.state.skusToProcess);
            data.append('skus-file', this.state.file);
            data.append('index_js_dir', this.state.indexJsDir);
            data.append('recreate_db', 1);

            request.onreadystatechange = () => {
                if (request.responseText.length) {
                    show(request.responseText);
                }
                if (request.readyState === XMLHttpRequest.DONE) {
                    console.log('CGI processing and Google processing complete.');
                    window.wizard.nextPage('review-specific-index', this.state.indexJsDir);
                    return Promise.resolve();
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadSkus + '?' + authString(this.state.access_token));
            request.send(data);
        }

        var pageResumePreviousAfterRender = async function () {
            console.log('Enter resume previous job');
            var buffer = '',
                data = new FormData(),
                logwindow = document.getElementById('logWindow'),
                request = new XMLHttpRequest(),
                show = (html) => {
                    logwindow.innerHTML = html;
                    logwindow.scrollTop = logwindow.scrollHeight + logwindow.clientHeight;
                }
            ;
            logwindow.setAttribute('style', 'position:relative;overflow:auto;height:20em;font-family: monospace; white-space: pre;');

            data.append('action', 'resume-previous');
            data.append('index_js_dir', this.state.indexJsDir);
            data.append('recreate_db', 0);

            request.onreadystatechange = () => {
                if (request.responseText.length) {
                    show(request.responseText);
                }
                if (request.readyState === XMLHttpRequest.DONE) {
                    console.log('CGI processing and Google processing complete.');
                    window.wizard.nextPage('review-specific-index', this.state.indexJsDir);
                    return Promise.resolve();
                } else {
                    console.error('Not ready', request.readyState, request.responseText);
                }
            }
            request.open('POST', Config.endpoints.uploadSkus + '?' + authString(this.state.access_token));
            request.send(data);
        };

        var pagePreviewDbBeforeRender = async function () {
            console.log('Load ', Config.endpoints.previewDb);
            var response = await window.fetch(
                Config.endpoints.previewDb
            );
            var json = await response.json();
            this.callMethod(viewIndex, json);
        };

        var viewIndex = function (json) {
            this.state.skus2ids = [];
            for (var sku in json.sku2tableInternalId) {
                this.state.skus2ids.push({
                    sku,
                    id: json.tableInternalId2googleTableId[ json.sku2tableInternalId[sku] ]
                });
            }
            var ids = {};
            for (var id in json.tableInternalId2googleTableId) {
                var googleTableId = json.tableInternalId2googleTableId[id];
                ids[googleTableId] ++;
            }
            this.state.tableInternalId2googleTableId = Object.keys(ids).sort();
        };

        var pageReviewSpecificIndexBeforeRender = async function (e) {
            if (e instanceof Array) {
                e = e[0]
            }
            if (typeof e === 'string') {
                this.state.jobName = e;
            } else {
                // Called by click event
                this.state.jobName = ('/' + this.state.indexBaseDir + '/' + e.target.innerText).replace(/\/+/g, '/');
            }
            var url = (this.state.jobName + '/index.js').replace(/\/+/g, '/');
            var response = await window.fetch(url);
            var json = await response.json();
            this.callMethod(viewIndex, json);
            console.log('Leave pageReviewSpecificIndexBeforeRender with ', this.state.skus2ids)
        }

        // Relies upon server auto-indexing (NB .htaccess created in Izel.pm)
        var pageReviewIndexesBeforeRender = async function () {
            var response = await window.fetch(
                this.state.indexBaseDir
            );
            var text = await response.text();
            console.log('Got the text', text);
            this.state.indexes = _linksFromText(text);
            console.log('Leaving, having set ', this.state.indexes);
        }

        var _linksFromText = function (str) {
            var m,
                rv = [],
                regexp = /\bhref=(.)([^/]+?)\/\1/g
            ;
            while (m = regexp.exec(str)) {
                rv.push( m[2])
            }
            return rv;
        }

        /**
         * Pages are `script` elements of `type` `text/handlebars`,
         *  with a `data-page-name` attribute.
         *
         * @example
         *  <script type=<script type='text/handlebars' data-page-name='manual-auth'> ...
         *
         * Pages are displayed via `Wizard.nextPage(:pageName)`.
         *
         * ## Data for Page Templates
         *
         * The Wizard supplies itself as `wizard`.
         *
         * ## Linking Within Pages
         *
         * Before templates are displayed, hyperlinks are added to any element that has an attribute
         * `data-goto-page`: the attribute's value can be a page name.
         *
         * ## Code For Pages
         *
         * Before a page is rendered, the Wizard will try to call a function with a camel-cased version
         * of the ant-cased page name, prefixed with the word 'page'.
         *
         * @example
         *  <script type=<script type='text/handlebars' data-page-name='manual-auth'> ...
         *  function pageManualAuth () { ...
         *
         * After a page is displayed, the Wizard will try to call a function with the same name, and the
         * suffix 'AfterRender`:
         *
         *  function pageManualAuthAfterRender () { ...
         *
         * Note that a suffix `BeforeRender` may be added to the function called before the page is rendered.
         *
         *  function pageManualAuthBeforeRender () { ...
         *
         * All three functions are called in the context of the Wizard.
         *
         * Yeah, @decorators would be nice without trainspoiling.
         *
         */
        var Wizard = function (state) {
            this.state = {};
                // pageName: null,
                // lastPageName: null
            // window.history.popstate();?
            Object.keys(state).forEach((key) => {
                this.state[key] = state[key];
            });
            this.pageEl = null;
            this.el = {
                main: document.getElementById('main'),
                ctrlNext: document.getElementById('ctrl-next'),
                ctrlBack: document.getElementById('ctrl-back'),
                ctrlCancel: document.getElementById('ctrl-cancel'),
                spinner: document.getElementById('spinner'),
            };
            this.hideSpinner();
            this.el.main.setAttribute('style', 'display:block"');
            window.popstate = (e) => {
                console.log('POPSTATE ', e);
                return false;  //pushstate
            };
        }

        Wizard.prototype.callMethod = function (method, ...args) {
            console.log('callMethod ', method, args);
            if (typeof method === 'string') {
                method = window[method];
            }
            return method.apply(this, args);
        }

        /**
         * Hides the current page, and processes and shows the template for the element
         * for the page element whose * `id` attribute matches
         * the prefix `page-` suffixed with the incremented page number. If a function
         * exists matching the suffix `page` with the prefix of the page number, it
         * will be called after the template has been processed and displayed.
         *
         * If the numbered page does not exist, the page with the next-highest number is shown.
         *
         * Also, if no arg supplied, tries to find data-next-page='name|number' from the current page.
         *
         * @param {number} [pageNumber] - Optional page number to which to jump.
         * @return void
         */
        Wizard.prototype.nextPage = async function (pageName, ...passOnArgs) {
            console.log('Enter Wizard.nextPage with %s -----------------------------------------', pageName);

            // If not told where to go, check the current template for instructions
            if (! pageName && this.pageEl.nextPageName) {
                pageName = this.pageEl.nextPageName;
                console.log('Got next-page pageName from data-next-page: ', pageName);
            }

            this.pageEl = document.querySelector('script[type="text/handlebars"][data-page-name="' + pageName + '"]');
            if (! this.pageEl) {
                this.el.main.innerHTML = '<h2>Error</h2><p>Could not find the requested page, ' + pageName + '</p>';
                return;
            }
            this.state.nextPageName = this.pageEl.dataset.nextPage || null;

            this.state.pageName = pageName;

            var fnNames = [
                'page-' + this.state.pageName,
                'page-' + this.state.pageName + '-before-render'
            ];

            await this._execute(fnNames, passOnArgs);

            this.render();

            if (this.state.pageName) {
                await this._execute('page-' + this.state.pageName + '-after-render', passOnArgs);
            }

            this.state.lastPageName = this.state.pageName;

            window.location.hash = this.state.pageName;
            window.history.pushState( this.state, 'Page '+this.state.pageName, window.location.toString() );

            console.log('Leave nextPage with page = ', this.state.pageName);
        }

        Wizard.prototype._execute = async function (fns, passOnArgs) {
            console.log('Wizard._execute', fns);
            if (! fns) return;
            var promises = [];
            if (typeof fns === 'string') fns = [fns];
            for (f of fns) {
                var fn = this._antsToCamelCase(f);
                console.log('Look for ', fn);
                if (typeof window[fn] === 'function') {
                    console.log('Found %s, calling....', fn);
                    promises.push( window[fn].call(this, passOnArgs) );
                    console.log('...called  %s', fn);
                } else {
                    console.log('Did not find ', fn);
                }
            }
            if (promises) {
                console.log('Waiting on ', promises.length, promises);
                await Promise.all(promises);
                console.log('Done all promises');
            }
            else {
                console.log('Leave now');
                return Promise.resolve();
            }
        };

        Handlebars.registerHelper('wizardIncludeTemplate', function(templateId) {
            var html = Handlebars.compile(
                document.getElementById(templateId).innerHTML.toString()
            )(
                { wizard: this.wizard }
            );
            return new Handlebars.SafeString(html);
        });

        // Wizard.prototype.includeTemplate = function () {
        //     console.log('-------', this);
        // }

        Wizard.prototype.render = function () {
            console.log('Enter render');
            try {
                // this.el.main.innerHTML = handlebars.render(
                //     this.pageEl.innerHTML.toString(),
                //     { wizard: this }
                // );
                // No caching:
                this.el.main.innerHTML = Handlebars.compile(
                    this.pageEl.innerHTML.toString()
                )(
                    { wizard: this }
                );
                var links = document.querySelectorAll('[data-goto-page]');
                for (var el of links) {
                    el.setAttribute('style',
                        el.getAttribute('style') + ';cursor:pointer;'
                    );
                    el.onclick = (e) => {
                        this.showSpinner();
                        this.nextPage(e.target.dataset.gotoPage, e);
                        this.hideSpinner();
                    };
                };
            } catch (e) {
                console.error(e);
            }
        }

        Wizard.prototype.showSpinner = function () {
            this.el.spinner.style = 'display: block;';
        };

        Wizard.prototype.hideSpinner = function () {
            this.el.spinner.style = 'display: none;';
        };

        Wizard.prototype._antsToCamelCase = function (str) {
            return str.replace(/-(\w)/g, (_, initial) => {
                return initial.toUpperCase();
            });
        }

    </script>

    <script type='text/handlebars' id='page-100' data-page-name='manual-auth'>
        <p>
            <button id='authButton' name='authButton'>Log In</button>
        </p>
    </script>

    <script type='text/handlebars' data-page-name='intro'>
        <p>
            We have too much data to fit into a single Fusion table, so this
            app creates several tables and an index which is referenced by
            the map pages.
        </p>
        <ul>
            <li data-goto-page='select-skus'>Rebuild - upload new SKU geography for processing</lia>
            <li data-goto-page='resume-previous'>Resume the last job</lia>
            <li data-goto-page='preview-db'>Preview SKUs already uploaded to Google</li>
            <li data-goto-page='review-indexes'>Publish previously uploaded SKU geography</li>
        </ul>
    </script>

    <script type='text/handlebars'data-page-name='select-skus'>
        <h2>Upload SKU Geography</h2>
        <div id='enterSkusToProcess'>
            <p><label for='skusToProess'>Please enter a list of USDA symbols/SKUs to proceess. Separate mulitple values with spaces and/or commas.</p>
            <p>
                <textarea id='skusToProcess' name='skusToProcess'></textarea>
            </p>
        </div>
        <div id='selectCsv'>
            <p><label for='skusCsv'>To create a new Fusion Table, select a SKU CSV file from your local machine:</label></p>
            <p><input type='file' name='skusCsv' id='skusCsv' placeholder='SKUs CSV' type='.csv'></p>
        </div>
        <!--
        <div id='listFusionTables' style='display:none'>
            <p>Or choose an existing Fusion Table from this list of tables stored in your Google account:</p>
            <select id='fusionTableIds' name='fusionTableIds'>
                {{#wizard.fusionTableDetails}}
                    <option value='{{tableId}}'>{{name}} - {{description}}</option>
                {{/wizard.fusionTableDetails}}
            </select>
            <button id='selectFusionTable' name='selectFusionTable'>Choose</button>
        -->
    </script>

    <script type='text/handlebars' id='page-3' data-page-name='preview-upload'>
        <h2>Does this look right?</h2>
        <p>USDA SKUs to process:</p>
        <p>{{wizard.state.skusToProcess}}</p>
        <dl>
            <dt>Name<dt><dd>{{wizard.state.file.name}}</dd>
            <dt>Size<dt><dd>{{wizard.state.file.size}}</dd>
            <dt>Last Modified<dt><dd>{{wizard.state.file.lastModifiedDate}}</dd>
        </dl>
        <button id="upload-skus">Process this SKU/geography file?</button>
        <button id="cancel-skus">Cancel</button>
    </script>

    <script type='text/handlebars' data-page-name='upload-skus'>
        <h2>Creating maps... </h2>
        <div id='logWindow'></div>
    </script>

    <script type='text/handlebars' id='publish-tables-and-skus'>
        <h3>Publish Maps</h3>
        <p>Maps need to be published by hand before they can be previewed. This will not effect the website's maps.</p>
        <p>
            Follow each link, select <kbd>File</kbd> &gt; <kbd>Share</kbd> &gt; <q>Private (change)</q> &gt;
            <q>On - anyone with the link can view</q>.
        </p>
        <ul>
            {{#wizard.state.tableInternalId2googleTableId}}
                <li><a target='_new' href='https://fusiontables.google.com/DataSource?docid={{.}}'>{{.}}</a></li>
            {{/wizard.state.tableInternalId2googleTableId}}
        </ul>
        <h3>SKU Map Previews</h3>
        <ul class='skus'>
            {{#wizard.state.skus2ids}}
                <li>
                    <a target='_new' href='preview-map.html?sku={{sku}};tableId={{id}}'>
                        {{sku}}
                    </a>
                </li>
            {{/wizard.state.skus2ids}}
        </ul>
    </script>

    <script type='text/handlebars' data-page-name='preview-db'>
        <h2>SKUs So Far</h2>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

    <script type='text/handlebars' data-page-name='resume-previous'>
        <h2>Creating Maps</h2>
        <div id='logWindow'><p>Resuming the previous job.</p></div>
    </script>

    <script type='text/handlebars' data-page-name='review-indexes'>
        <h2>Please select an index</h2>
        {{window.wizard.state.indexes}}
        <ul>
            {{#wizard.state.indexes}}
                <li data-goto-page='review-specific-index'>{{.}}</li>
            {{/wizard.state.indexes}}
        </ul>
    </script>

    <script type='text/handlebars' data-page-name='no-indexes'>
        <h2>There are no indexes.</h2>
        <p>Please upload some SKU/geography.</h2>
    </script>

    <script type='text/handlebars' data-page-name='review-specific-index'>
        <h2>{{wizard.state.jobName}}</h2>
        {{#wizardIncludeTemplate "publish-tables-and-skus"}}{{/wizardIncludeTemplate}}
    </script>

</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <header>
        <h1>Map Updater</h1>
    </header>

    <main id='main'>
        <h2>Welcome to the map making page.</h2>
        <p>
            Authorising with Google....
        </p>
        <p>
            <button style='display:none' id='authButton' name='authButton'>Log In</button>
        </p>
    </main>

    <footer style='display:none'>
        <div style='width:50%;float:left;'>
            <button id='ctrl-cancel'>Cancel</button>
        </div>
        <div style='width:50%;float:left;text-align:right'>
            <button id='ctrl-back'>Back</button>
            <button id='ctrl-next'>Next</button>
        </div>
    </footer>


    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID.
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->

        <div id="spinner" class="loader">Loading...</div>
        <script src="https://apis.google.com/js/client.js?onload=ENTER"></script>
</body>

</html>