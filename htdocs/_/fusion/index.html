<!DOCTYPE html>

<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>County-level Plant Species Distribution</title>

  <style>
    html,
    body,
    #map-canvas {
      height: 100%;
      margin: 0px;
      padding: 0px
    }
  </style>

  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
  <script src="https://apis.google.com/js/client.js?onload=initialize"></script>

  <script>
    var PROD = window.location.host.indexOf('localhost') === -1;
    var FUSION_TABLE_IDS = [
      '1LglOCvH_uligumYtUCS9lw9cdG-Gpcs8mz36H8NG',
      '1yktl7CmjbeNQpdPLjYo4ip_5klk08DECgzWOcOjs',
      '1gfI5LZ3cO0Ekz3CIzI1YaSnhCC8adpAbWw-0oZNz',
      '1136dRv8wiKPqTn2to4Jo9lkk7dfjS5PLG4KLmaK',
      '1brpLxQ8LErMmD4rOOlSlyKg3wMtQ9U6FNgrnSNNt'
    ];

    Array.prototype.contains = function (subject) {
      for (var i = 0; i < this.length; i++) {
        if (this[i] == subject) return true;
      }
      return false;
    }

    var LeeFusionMap = function () {
      this.center = new google.maps.LatLng(
        39.50, -98.35   //  LAT. 39°50' LONG. -98°35' - centre of the continental USA
      );
      this.apiKey = PROD ? 'AIzaSyDBob2s-CgtHT6172BXX8PzEinSG3qyp3g' : 'AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY';
      // this.apiKey = PROD ? 'AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY' : 'AIzaSyDbgFEQy6WguaLRlRF0v3YbOzHgLeJo5iI';
      this.initialZoom = 4;      	// 0=far out, 18?=close-up
      this.minZoomLevel = 7;
      // this.scopes         = 'https://www.googleapis.com/auth/fusiontables';

      this.sku = window.location.hash.substring(1)
        || window.location.search.substring(1)
        || null;

      if (this.sku === null) {
        alert("Missing SKU in URI: should be at the end after a ? or a #");
        throw "No SKU in either location.search or location.hash!";
      }

      this.initApi();
      this.map = new google.maps.Map(document.getElementById('map-canvas'), {
        center: this.center,
        zoom: this.initialZoom
      });
    };

    LeeFusionMap.prototype.loadJson = function (next) {
      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType("application/json");
      xobj.open('GET', 'skus.json', true);
      xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          next( JSON.parse(xobj.responseText) );
        }
      };
      xobj.send(null);
    }

    /* SKU-to-Table map:
      our skus are in several tables, names in this.tables.
      In this data, SKUs point to an index of this.tables,
      which holds the fusion table names.
    
        This data is output by the script 'create_fusion.pl'
        as a file titled 'index.js'. Copy the contents to replace
        the value below — we could load it dynamically but that
        would slow down the page load.
    */
    LeeFusionMap.prototype.sku2table = function () {
        this.loadJson(function (jsonIndex) {
        var idx = jsonIndex.skus2tableIndex[this.sku];
        // var rv = FUSION_TABLE_IDS[idx];
        var rv = jsonIndex.tableIndex2tableId[idx];
        if (console) console.log('Using Fusion Table %s, id %s', idx, rv);
        return rv;
      })
    }

    LeeFusionMap.prototype.initApi = function () {
      var self = this;
      // gapi.client.setApiKey(this.apiKey);
      return;
    }

    /**
      // Run OAuth 2.0 authorization.
      window.setTimeout( function() {
        // Request auth
        gapi.auth.authorize({
          client_id: self.client_id,
          scope:     self.scopes,
          immediate: true
        },
        // Handle response
        function(){
          throw 'Not authorised - check api_key and client_id for this domain.'
        }
      }, 1);
    }
    **/

    LeeFusionMap.prototype.run = function () {
      var self = this;
      var layer = new google.maps.FusionTablesLayer({
        query: {
          select: '\'geometry\'',
          from: this.sku2table(),
          where: "sku='" + this.sku + "'"
          // where: "'FIPS formula' IN (48243.0)"
        }
      });
      layer.setMap(this.map);
      console.log('set fusion layer on map for [%s]', this.sku)
    }


    google.maps.event.addDomListener(window, 'load', function initialize() {
      var map = new LeeFusionMap();
      map.run()
    });
  </script>
</head>

<body>
  <div id="map-canvas"></div>
</body>

</html>
