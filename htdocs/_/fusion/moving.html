

<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>County-level Plant Species Distribution</title>


 <!--
 0IMZAFCwR-t7jZnVzaW9udGFibGVzOjIxMDIxNw
 210217
 -->   
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY"></script>
    <script src="https://apis.google.com/js/client.js?onload=initialize"></script>

    <script>

Array.prototype.contains = function( subject ){
    for (var i=0; i<this.length; i++){
      if (this[i] == subject) return true;
    }
    return false;
}

var LeeFusionMap = function(){
    // The clientId and apiKey are available at
    // https://code.google.com/apis/console. For more information, see
    // http://code.google.com/p/google-api-javascript-client/wiki/Authentication.
    this.apiKey = 'AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY';
    // AIzaSyDbgFEQy6WguaLRlRF0v3YbOzHgLeJo5iI';
    this.center = new google.maps.LatLng(
        39.50, -98.35   //  LAT. 39°50' LONG. -98°35' - centre of the continental USA
    );
    this.client_id      = '924971419417.apps.googleusercontent.com';
    this.api_key        = 'AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY';
    this.initialZoom    = 4;      // 0=far out, 18?=close-up
    this.minZoomLevel   = 7;      
    this.maxResults     = 1000;   // For show tables
    this.dbUri          = 'sku2fips.cgi/';
    this.fusionTablesEndpoint = 'https://www.googleapis.com/fusiontables/v1/';
    /*
    this.map   = new google.maps.Map(document.getElementById('map-canvas'), {
      center: this.center,
      zoom: this.initialZoom
    });
    */
    this.GEO_TABLE = '0IMZAFCwR-t7jZnVzaW9udGFibGVzOjIxMDIxNw';
    this.scopes    = 'https://www.googleapis.com/auth/fusiontables';
    
   this.sku = window.location.hash.substring(1)
           || window.location.search.substring(1)
           || null;

    if (this.sku === null){
      alert("Missing SKU in URI: should be at the end after a ? or a #");
      throw "No SKU in either location.search or location.hash!";
    }

    this.initApi();
};

LeeFusionMap.prototype.initApi = function(){
  var self = this;
  gapi.client.setApiKey(apiKey);
  // Run OAuth 2.0 authorization.
  window.setTimeout( function() {
    // Request auth
    gapi.auth.authorize({
      client_id: self.client_id,
      scope:     self.scopes,
      immediate: true
    },
    // Handle response
    function(){
      throw 'Not authorised - check api_key and client_id for this domain.'
    }
  }, 1);
}


// List tables
// Does view exist?
// Yes 
//    Get sku fips data from view
// No 
//    Create table for sku fips
//    Get sku fips data from mysql
//    Populate table for sku fips
//    Create merged view of sku fips and geo
// Plot map with FusionTablesLayer
LeeFusionMap.prototype.run = function(){
    var self = this;
    // List tables
    gapi.client.request({
        path:     this.fusionTablesEndpoint+'tables',
        params:   this.maxResults,
        callback: function(res){
            var json = JSON.stringify(res);
            console.info(json);
            // Does view exist?
            if (json.items.contains(this.viewName())){
              // Get sku fips data from view
              self.getFIPS();
            }
            else {

            }
        }
    });

   this.jsonFromURI( , {
        always: function(tables){
            console.log('Tables I own:', tables);
            // If this.skuTableName does not exist create
            // and then call createView
            this.createTableForSku( this.createView );
            // Otherwise call creteView now: this.createView();
        }
    });
}
  // Does view exist?
  // Yes 
  //    Get sku fips data from view
  // No 
  //    Create table for sku fips
  //    Get sku fips data from mysql
  //    Populate table for sku fips
  //    Create merged view of sku fips and geo
  // Plot map with FusionTablesLayer
}

LeeFusionMap.prototype.auth = function(){
    var self = this;
    var uri = 'https://accounts.google.com/o/oauth2/auth?client_id='
      + this.client_id
      + '&redirect_uri='
    var xhr     = new XMLHttpRequest();
    xhr.onerror = opts.onerror;
    xhr.onload  = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
           self.fromURI();
        }
      }
    });
    xhr.open('GET', uri, true);
    xhr.send(null);
}


LeeFusionMap.prototype.jsonFromURI = function(uri, opts){
    var self = this;
    opts.method  = opts.method || 'GET';
    opts.success = opts.success || function (e) {
      throw 'OK, but no success method!'
    }
    opts.onerror = opts.onerror || function (e) {
      console.error(xhr.statusText);
    }
    var xhr     = new XMLHttpRequest();
    xhr.onerror = opts.onerror;
    xhr.onload  = function (e) {
      if (xhr.readyState === 4) {
        if (opts.always) opts.always.call(self,json);
        if (xhr.status === 200) {
          console.log(xhr.responseText);
          var json;
          eval( 'json=' + xhr.responseText ); // er...
          opts.success.call(self,json);
        } 
        else {
          console.error(xhr.statusText);
        }
      }
    }
    xhr.open(opts.method, uri, true);
    xhr.send(null);
}

LeeFusionMap.prototype.getFIPS = function( next ){
  var self = this;
  this.jsonFromURI( this.dbUri + this.sku, {
    success: function(json){
      if (json.error) console.error( json.error );
      else next.call( self, json.county_fips );
    }
  });
};

LeeFusionMap.prototype.skuTableName = function(){
    return 'IzelSku' + this.sku
};

LeeFusionMap.prototype.viewName = function(){
    return 'IzelView' + this.sku
};

LeeFusionMap.prototype.mapFIPS = function(fips){
    for (var i = 0; i < fips.length; i++){
        var where = '';
        if (i >= fips.length) break;
        where += "'"+fips[i]+"',"
    }
    where = where.substring( 0, where.length-1 );
    console.info(where);
    var layer = new google.maps.FusionTablesLayer({
        query: {
            select: '\'geometry\'',
            from: this.GEO_TABLE,
            where: "'FIPS formula' IN ("+where+")"
        }
    });
    layer.setMap( this.map );
}

LeeFusionMap.prototype.createTableForSku = function(next){
    var self = this;
    var createTable = '{'
    + '"name": "' + this.skuTableName() + '",'
    + '"columns": ['
    + '{ "name": "FIPS", "type": "NUMBER" }'
    + '],'
    + '"isExportable": true'
    + '}';

    gapi.client.request({
        path: '/fusiontables/v1/tables',
        body: createTable,
        method: 'POST'
    }
    .execute(
      function(res) {
          var output = JSON.stringify(res);
          console.info('create table returned: ', output);
          tableId = res['tableId'];
          self.getFIPS(
             self.insertTableForSku,
             next
          );
      })
    );
}

LeeFusionMap.prototype.insertTableForSku = function(next){
    this.apiQuery(
      'insert into '+this.tableId+' (FIPS) values ('+
        fips.join(',')
        +')',
      next
    )
  );
}

// Send an SQL query to Fusion Tables.
LeeFusionMap.prototype.apiQuery(query, next) {
  if (query.match(/^(select|show|describe)/){
    gapi.client.request({
      method: 'POST',
      path: '/fusiontables/v1/query',
      body: 'sql=' + encodeURIComponent(query),
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Content-Length': body.length
      }
    })
    .execute(
      function(res){
        console.info('apiQuery responded:', JSON.stringify(res) );
        next.call(self);
      )
    );
  }

  else {
    gapi.client.request({
      path: path,
      params: { 'sql': query }
    })
    .execute(
      function(res){
        console.info('apiQuery responded:', JSON.stringify(res) );
        next.call(self);
      )
    );
  }
}

/* Create a 'merged view' of the counties and fips, because
   most SKUs have too many FIPS to fit into a GET request, 
   resulting in a 414/Request Too Large error. */
LeeFusionMap.prototype.createView = function(){
    /* Create merged table of geo and fips for sku */
    var sql = 'CREATE VIEW '+this.viewName(this.sku) +' AS ('
      + 'SELECT ' + this.GEO_TABLE + "'FIPS formula' "
      + "FROM '" + this.GEO_TABLE + '", "'+this.skuTableName(this.sku) +"'"
    + ')';
  
     console.log(sql);
     this.jsonFromURI( this.fusionTablesEndpoint + 'query?sql=' + encodeURI(sql), {
        always: function(r){
          console.info(r)
        }    
   });
}

google.maps.event.addDomListener(window, 'load', function initialize() {
  var map = new LeeFusionMap();
  map.run()
});




    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>

<!--

  Notes: 'FIPS formula' is sprintf('%d'+'%03d'+'.0')

GEO_ID: 05000US06001
GEO_ID2: 6001
Geographic Name: Alameda County, California
STATE num: 6
COUNTY num: 1
FIPS formula: 6001.0


GEO_ID: 05000US48243
GEO_ID2: 48243
Geographic Name: Jeff Davis County, Texas
STATE num: 48
COUNTY num: 243
FIPS formula: 48243.0

Oauth2
Client ID 924971419417.apps.googleusercontent.com
Email Address 924971419417@developer.gserviceaccount.com

 Key for browser applications 
 API key  AIzaSyA9xkZrMWurQT8GcggBSYdgBAEUunGFG7o
Referers  *.leegoddard.net/*
Activation date   May 10, 2014 11:34 AM
Activated by  leegee@gmail.com (you) 


API key   AIzaSyCBeQP3Cje-GNZTxD0enheKc3lEu4CGzuY
Referers  

    localhost/*

Activation date   May 10, 2014 11:38 AM
Activated by  leegee@gmail.com (you)

-->

